{"version":3,"file":"authMiddleware.js","sourceRoot":"","sources":["../../middleware/authMiddleware.ts"],"names":[],"mappings":";;;;;AAcA,wCA4BC;AAED,oDAYC;AAtDD,kEAAmC;AACnC,uDAAoD;AACpD,kGAAwE;AACxE,uDAAgE;AAEhE,SAAS,kBAAkB,CAAC,GAAY;IACtC,OAAO;QACL,KAAK,EAAE,GAAG,CAAC,OAAO,CAAC,YAAY,CAAC,IAAI,EAAE;QACtC,OAAO,EAAE,GAAG,CAAC,EAAE,IAAI,EAAE;KACtB,CAAC;AACJ,CAAC;AAEM,KAAK,UAAU,cAAc,CAClC,GAAY,EACZ,GAAa,EACb,IAAkB;IAElB,MAAM,KAAK,GAAG,GAAG,CAAC,OAAO,EAAE,YAAY,CAAC;IACxC,MAAM,WAAW,GAAG,kBAAkB,CAAC,GAAG,CAAC,CAAC;IAE5C,IAAI,CAAC,KAAK;QACR,OAAO,GAAG;aACP,MAAM,CAAC,mBAAI,CAAC,YAAY,CAAC;aACzB,IAAI,CAAC,EAAE,KAAK,EAAE,sBAAsB,EAAE,CAAC,CAAC;IAE7C,MAAM,OAAO,GAAG,uBAAU,CAAC,iBAAiB,CAAC,KAAK,CAAC,CAAC;IACpD,IAAI,CAAC,OAAO;QACV,OAAO,GAAG;aACP,MAAM,CAAC,mBAAI,CAAC,YAAY,CAAC;aACzB,IAAI,CAAC,EAAE,KAAK,EAAE,0BAA0B,EAAE,CAAC,CAAC;IAEjD,IACE,OAAO,CAAC,aAAa;QACrB,CAAC,IAAA,4BAAa,EAAC,OAAO,CAAC,aAAa,EAAE,WAAW,CAAC,EAClD,CAAC;QACD,OAAO,GAAG,CAAC,MAAM,CAAC,mBAAI,CAAC,YAAY,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,kBAAkB,EAAE,CAAC,CAAC;IAC3E,CAAC;IAEA,GAAW,CAAC,IAAI,GAAG,OAAO,CAAC;IAC5B,IAAI,EAAE,CAAC;AACT,CAAC;AAEM,KAAK,UAAU,oBAAoB,CACxC,GAAY,EACZ,GAAa,EACb,IAAkB;IAElB,MAAM,cAAc,CAAC,GAAG,EAAE,GAAG,EAAE,KAAK,IAAI,EAAE;QACxC,MAAM,IAAI,GAAI,GAAW,CAAC,IAAI,CAAC;QAC/B,MAAM,OAAO,GAAG,MAAM,wBAAc,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QAC1D,IAAI,CAAC,OAAO;YACV,OAAO,GAAG,CAAC,MAAM,CAAC,mBAAI,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,aAAa,EAAE,CAAC,CAAC;QACnE,IAAI,EAAE,CAAC;IACT,CAAC,CAAC,CAAC;AACL,CAAC","sourcesContent":["// middlewares/authMiddleware.ts\nimport { Request, Response, NextFunction } from 'express';\nimport HTTP from '@Util/HTTPCodes';\nimport { jwtService } from '../services/jwtService';\nimport authController from '@controllers/authController/authController';\nimport { UserHeaders, verifySession } from '@Util/Session_Util';\n\nfunction extractUserHeaders(req: Request): UserHeaders {\n  return {\n    agent: req.headers['user-agent'] || '',\n    ip_addr: req.ip || '',\n  };\n}\n\nexport async function authMiddleware(\n  req: Request,\n  res: Response,\n  next: NextFunction,\n) {\n  const token = req.cookies?.access_token;\n  const userHeaders = extractUserHeaders(req);\n\n  if (!token)\n    return res\n      .status(HTTP.UNAUTHORIZED)\n      .json({ error: 'Missing access token' });\n\n  const payload = jwtService.verifyAccessToken(token);\n  if (!payload)\n    return res\n      .status(HTTP.UNAUTHORIZED)\n      .json({ error: 'Invalid or expired token' });\n\n  if (\n    payload.session_token &&\n    !verifySession(payload.session_token, userHeaders)\n  ) {\n    return res.status(HTTP.UNAUTHORIZED).json({ error: 'Session mismatch' });\n  }\n\n  (req as any).user = payload;\n  next();\n}\n\nexport async function adminCheckMiddleware(\n  req: Request,\n  res: Response,\n  next: NextFunction,\n) {\n  await authMiddleware(req, res, async () => {\n    const user = (req as any).user;\n    const isAdmin = await authController.isAdmin(user.userId);\n    if (!isAdmin)\n      return res.status(HTTP.FORBIDDEN).json({ error: 'Admins only' });\n    next();\n  });\n}\n"]}