{"version":3,"file":"authController.js","sourceRoot":"","sources":["../../../controllers/authController/authController.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Purpose:\n *  - Authentication controller responsible for handling user login, registration,\n *    password recovery, and role validation (admin check).\n * Notes:\n *  - Uses bcrypt for password hashing/validation and nodemailer for email-based OTP.\n *  - Depends on DBController for database connections.\n *  - Sentry is used for error tracking across all methods.\n *  - Types (e.g., Auth.UserInfo) are imported from auth_types.d.ts.\n */\n\nimport Database from '@controllers/DBController/DBController';\nimport { randomUUID } from 'crypto';\nimport Auth from '@controllers/authController/auth_types'; //types import\nimport bcrypt from 'bcryptjs';\nimport nodemailer from 'nodemailer';\nimport dotenv from 'dotenv';\nimport * as Sentry from '@sentry/node';\n\ndotenv.config();\nconst log = console.log;\nvar salt = bcrypt.genSaltSync(10);\n// salt here is generated once at startup nd reused for password hashing.\n\n/**\n * Authenticates a user by verifying their email and password.\n *\n * @param {string} email - The email of the user attempting to log in.\n * @param {string} password - The plaintext password provided by the user.\n * @returns {Promise<Auth.UserInfo | undefined>} - The authenticated user object if credentials are correct, otherwise undefined.\n */\nasync function authenticate(\n  email: string,\n  password: string,\n): Promise<Auth.UserInfo | undefined> {\n  const authConn = await Database.getConnection();\n\n  if (authConn) {\n    try {\n      // Step 1: Query the database for the user by email only\n      // Only email is queried here, password verification done later via bcrypt.\n      const result = await authConn\n        .request()\n        .input('email', Database.msSQL.VarChar, email)\n        .query('SELECT * FROM AppUser WHERE email = @email');\n\n      // Step 2: Check if user exists and if the password matches\n      if (result.recordset && result.recordset.length > 0) {\n        const user = result.recordset[0];\n\n        // Compare the plain-text password with the stored hashed password\n        const isPasswordValid = await bcrypt.compare(password, user.password);\n\n        if (isPasswordValid) {\n          return user; // Authentication successful\n        } else {\n          log('Incorrect email or password', email);\n        }\n      } else {\n        log('User not found', email);\n      }\n    } catch (error) {\n      Sentry.captureException({ error: 'Backend error - authenticate' });\n      log('Error in login\\n', error);\n    }\n  }\n\n  return undefined;\n}\n\n/**\n * Registers a new user in the database.\n *\n * @param {Auth.UserInfo} userInfo - Object containing user details (email, password, fullname, type).\n * @returns {Promise<{ id: string } | undefined>} - The newly created user's ID, or undefined if registration fails.\n */\n// IMPROVEMENT: verify user email - maybe use magic link\n// IMPROVEMENT: strong password enforcement\nasync function registerUser(\n  userInfo: Auth.UserInfo,\n): Promise<{ id: string } | undefined> {\n  const authConn = await Database.getConnection();\n\n  if (undefined !== authConn) {\n    const { email, password, fullname, type } = userInfo;\n    const id = randomUUID();\n\n    try {\n      const result = await authConn\n        .request()\n        .input('id', Database.msSQL.VarChar, id)\n        .input('email', Database.msSQL.VarChar, email)\n        .input('password', Database.msSQL.VarChar, password)\n        .input('fullname', Database.msSQL.VarChar, fullname)\n        .input('type', Database.msSQL.VarChar, type)\n        .query(\n          'INSERT INTO AppUser ( id,  email,  password,  fullname,  type) \\\n              OUTPUT INSERTED.*                                         \\\n                          VALUES  (@id, @email, @password, @fullname, @type)',\n        );\n\n      if (undefined === result.recordset) {\n        log('Error inserting record ', result.recordset);\n      } else {\n        return result.recordset[0];\n      }\n    } catch (error) {\n      Sentry.captureException({ error: 'Backend error - register user' });\n      log('Error in Sign Up\\n', error);\n    }\n  }\n}\n\n// Forgot Password\nasync function forgotPassword(\n  email: string,\n): Promise<{ message: string } | undefined> {\n  // Attempt to connect to the database\n  const authConn = await Database.getConnection();\n\n  if (!authConn) {\n    log('Database connection failed.');\n    return;\n  }\n\n  // Query DB for user email\n  try {\n    const result = await authConn\n      .request()\n      .input('email', Database.msSQL.VarChar, email)\n      .query('SELECT * FROM AppUser WHERE email = @email');\n\n    // Validation\n    if (!result.recordset || result.recordset.length === 0) {\n      log('User not found for email:', email);\n      return;\n    }\n\n    // Generate OTP (one time pass)\n    const otp = Math.floor(1000 + Math.random() * 9000);\n    const otpExpire = new Date();\n    otpExpire.setMinutes(otpExpire.getMinutes() + 2); // Set OTP expiry to 2 minutes (hard coded)\n\n    // Update user record with OTP and expiry\n    await authConn\n      .request()\n      .input('otp', Database.msSQL.Int, otp)\n      .input('otpExpire', Database.msSQL.DateTime, otpExpire)\n      .input('email', Database.msSQL.VarChar, email)\n      .query(\n        'UPDATE AppUser SET otp = @otp, otpExpire = @otpExpire WHERE email = @email',\n      );\n\n    // Create email transporter object to send email\n    const transporter = nodemailer.createTransport({\n      service: 'gmail',\n      auth: {\n        user: process.env.EMAIL_USER!,\n        pass: process.env.EMAIL_PASSWORD!,\n      },\n    });\n\n    // Configure mailing options\n    const mailOptions = {\n      from: process.env.EMAIL_USER!,\n      to: email,\n      subject: 'Password Reset',\n      text: `Your One Time Password (expires in 10 minutes): ${otp}\n\t\t\t\\nReset your password at: http://trackmydegree.com/reset-pass\n\t\t\t\\nIf you did not request this, please ignore this email.`,\n    }; // Change this to URL before adding to production\n\n    // Email sending logic is coupled directly into this controller\n    // We should consider moving to a dedicated mailer utility.\n\n    // Send email\n    await transporter.sendMail(mailOptions);\n\n    return { message: 'OTP has been sent to your email.' }; // Confirmation message\n  } catch (error) {\n    Sentry.captureException({ error: 'Backend error - forgot password' });\n    log('Error in forgot password:\\n', error);\n  }\n}\n\n// Reset Password\nasync function resetPassword(\n  otp: number,\n  password: string,\n  confirmPassword: string,\n): Promise<{ message: string } | undefined> {\n  // Make sure new password matches with confirmation\n  if (password !== confirmPassword) {\n    log('Passwords do not match.');\n    return;\n  }\n\n  // Connect to the database\n  const authConn = await Database.getConnection();\n  if (!authConn) {\n    log('Database connection failed.');\n    return;\n  }\n\n  // Query the database for the OTP that matches the user's input\n  // Is it safe to query for the OTP\n  try {\n    const result = await authConn\n      .request()\n      .input('otp', Database.msSQL.Int, otp)\n      .query(\n        'SELECT * FROM AppUser WHERE otp = @otp AND otpExpire > GETDATE()',\n      );\n\n    // Validate OTP\n    if (!result.recordset || result.recordset.length === 0) {\n      log('Invalid or expired OTP.');\n      return;\n    }\n\n    // Hash the new password\n    const hashedPassword = await bcrypt.hash(password, salt);\n\n    // Update the user's password and clear the OTP\n    await authConn\n      .request()\n      .input('password', Database.msSQL.VarChar, hashedPassword)\n      .input('otp', Database.msSQL.Int, otp)\n      .query(\n        'UPDATE AppUser SET password = @password, otp = NULL, otpExpire = NULL WHERE otp = @otp',\n      );\n\n    return { message: 'Password reset successful.' };\n  } catch (error) {\n    Sentry.captureException({ error: 'Backend error - reset password' });\n    log('Error in reset password:\\n', error);\n  }\n}\n\nasync function isAdmin(user_id: string): Promise<boolean | undefined> {\n  const authConn = await Database.getConnection();\n\n  if (authConn) {\n    try {\n      const result = await authConn\n        .request()\n        .input('id', Database.msSQL.VarChar, user_id)\n        .query('SELECT type FROM AppUser WHERE id = @id');\n\n      if (result.recordset && result.recordset.length > 0) {\n        const user = result.recordset[0];\n\n        return user.type === 'admin';\n        // isAdmin simply checks the \"type\" field in DB\n      }\n\n      return false;\n    } catch (error) {\n      Sentry.captureException({ error: 'Backend error - isAdmin' });\n      log('Error in isAdmin:\\n', error);\n    }\n  }\n}\n\n//Namespace\nconst authController = {\n  authenticate,\n  registerUser,\n  forgotPassword,\n  resetPassword,\n  isAdmin,\n};\n\n//Default export\nexport default authController;\n"]}