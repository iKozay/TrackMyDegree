{"version":3,"file":"DegreeXCPController.js","sourceRoot":"","sources":["../../../controllers/DegreeXCPController/DegreeXCPController.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Purpose:\n *  - Helpers that read/write the DegreeXCoursePool table.\n *  - Provides create, read (list), update and delete operations for degree â†” coursepool mappings.\n * Notes:\n *  - Functions return a DB_OPS enum to signal high-level outcome.\n *  - Errors are logged to console and reported to Sentry.\n *  - Types for inputs are defined in DegreeXCP_types.d.ts and CoursePool types in coursepool_types.\n */\n\nimport Database from '@controllers/DBController/DBController';\nimport DegreeXCPTypes from '@controllers/DegreeXCPController/DegreeXCP_types';\nimport CoursePoolTypes from '@controllers/coursepoolController/coursepool_types';\nimport DB_OPS from '@Util/DB_Ops';\nimport { randomUUID } from 'crypto';\nimport * as Sentry from '@sentry/node';\n\nconst log = console.log;\n/**\n * Creates a new DegreeXCoursePool record in the database.\n *\n * @param {DegreeXCPTypes.NewDegreeXCP} new_record - The new degreeXcoursepool record to be created.\n * @returns {Promise<DB_OPS>} - The result of the operation (SUCCESS, MOSTLY_OK, or FAILURE).\n */\nasync function createDegreeXCP(\n  new_record: DegreeXCPTypes.NewDegreeXCP,\n): Promise<DB_OPS> {\n  const dbConn = await Database.getConnection();\n\n  if (dbConn) {\n    const { degree_id, coursepool_id, credits } = new_record;\n    const record_id = randomUUID();\n\n    try {\n      const result = await dbConn\n        .request()\n        .input('id', Database.msSQL.VarChar, record_id)\n        .input('degree', Database.msSQL.VarChar, degree_id)\n        .input('coursepool', Database.msSQL.VarChar, coursepool_id)\n        .input('creditsRequired', Database.msSQL.Int, credits)\n        .query(\n          'INSERT INTO DegreeXCoursePool \\\n              ( id, degree, coursepool, creditsRequired )\\\n              OUTPUT INSERTED.id\\\n              VALUES\\\n              (@id, @degree, @coursepool, @creditsRequired)',\n        );\n\n      if (undefined === result.recordset) {\n        // if insert didn't return expected insert id\n        log('Error inserting degreeXcoursepool record: ' + result.recordset);\n        Sentry.captureMessage(\n          'Error inserting degreeXcoursepool record: ' + result.recordset,\n        );\n        return DB_OPS.MOSTLY_OK;\n      } else {\n        return DB_OPS.SUCCESS;\n      }\n    } catch (error) {\n      Sentry.captureException(error);\n      log('Error in degreeXcoursepool creation\\n', error);\n    }\n  }\n\n  return DB_OPS.FAILURE;\n}\n/**\n * Retrieves all course pools associated with a specific degree.\n *\n * @param {string} degree_id - The ID of the degree.\n * @returns {Promise<{course_pools: CoursePoolTypes.CoursePoolItem[]} | undefined>} - A list of course pools associated with the degree, or undefined if an error occurs.\n */\n\nasync function getAllDegreeXCP(\n  degree_id: string,\n): Promise<{ course_pools: CoursePoolTypes.CoursePoolItem[] } | undefined> {\n  const dbConn = await Database.getConnection();\n\n  if (dbConn) {\n    try {\n      const result = await dbConn\n        .request()\n        .input('degree_id', Database.msSQL.VarChar, degree_id)\n        .query(\n          'SELECT cp.id, cp.name\\\n              FROM CoursePool cp\\\n              JOIN DegreeXCoursePool dxcp ON cp.id = dxcp.coursepool\\\n              WHERE dxcp.degree = @degree_id',\n        );\n\n      return {\n        course_pools: result.recordset,\n      };\n    } catch (error) {\n      Sentry.captureException(error);\n      log('Error fetching all course pools for given degree id\\n', error);\n    }\n  }\n\n  return undefined;\n}\n/**\n * Updates an existing DegreeXCoursePool record.\n *\n * @param {DegreeXCPTypes.DegreeXCPItem} update_record - The degreeXcoursepool record with updated information.\n * @returns {Promise<DB_OPS>} - The result of the operation (SUCCESS, MOSTLY_OK, or FAILURE).\n *\n * here the SET clause in SQL should include commas which it lacks at the moment\n */\nasync function updateDegreeXCP(\n  update_record: DegreeXCPTypes.DegreeXCPItem,\n): Promise<DB_OPS> {\n  const dbConn = await Database.getConnection();\n\n  if (dbConn) {\n    const { id, degree_id, coursepool_id, credits } = update_record;\n\n    try {\n      const result = await dbConn\n        .request()\n        .input('id', Database.msSQL.VarChar, id)\n        .input('degree', Database.msSQL.VarChar, degree_id)\n        .input('coursepool', Database.msSQL.VarChar, coursepool_id)\n        .input('creditsRequired', Database.msSQL.Int, credits)\n        .query(\n          'UPDATE DegreeXCoursePool  \\\n              SET \\\n                degree          = @degree \\\n                coursepool      = @coursepool \\\n                creditsRequired = @creditsRequired \\\n              OUTPUT INSERTED.id \\\n              WHERE   id = @id',\n        );\n\n      if (result.recordset.length > 0 && id === result.recordset[0].id) {\n        return DB_OPS.SUCCESS;\n      } else {\n        return DB_OPS.MOSTLY_OK;\n      }\n    } catch (error) {\n      Sentry.captureException(error);\n      log('Error in updating degreeXcoursepool item\\n', error);\n    }\n  }\n\n  return DB_OPS.FAILURE;\n}\n/**\n * Removes a DegreeXCoursePool record from the database.\n *\n * @param {DegreeXCPTypes.DegreeXCP} delete_record - The degreeXcoursepool record to be deleted.\n * @returns {Promise<DB_OPS>} - The result of the operation (SUCCESS, MOSTLY_OK, or FAILURE).\n */\n\nasync function removeDegreeXCP(\n  delete_record: DegreeXCPTypes.DegreeXCP,\n): Promise<DB_OPS> {\n  const dbConn = await Database.getConnection();\n\n  if (dbConn) {\n    const { degree_id, coursepool_id } = delete_record;\n\n    try {\n      const result = await dbConn\n        .request()\n        .input('degree', Database.msSQL.VarChar, degree_id)\n        .input('coursepool', Database.msSQL.VarChar, coursepool_id)\n        .query(\n          'DELETE FROM DegreeXCoursePool\\\n                  OUTPUT DELETED.degree\\\n                  WHERE degree     = @degree\\\n                  AND   coursepool = @coursepool',\n        );\n\n      if (\n        result.recordset.length > 0 &&\n        result.recordset[0].degree === degree_id\n      ) {\n        return DB_OPS.SUCCESS;\n      } else {\n        return DB_OPS.MOSTLY_OK;\n      }\n    } catch (error) {\n      Sentry.captureException(error);\n      log('Error in deleting degreeXcoursepool item\\n', error);\n    }\n  }\n\n  return DB_OPS.FAILURE;\n}\n\n// Exported controller API\nconst DegreeXCPController = {\n  createDegreeXCP,\n  getAllDegreeXCP,\n  updateDegreeXCP,\n  removeDegreeXCP,\n};\n\nexport default DegreeXCPController;\n"]}