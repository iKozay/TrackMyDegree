{"version":3,"file":"exemptionController.js","sourceRoot":"","sources":["../../../controllers/exemptionController/exemptionController.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Purpose:\n *  - Controller module for the Exemption table.\n *  - Provides functions to create, read, and delete exemptions for users and courses.\n * Notes:\n *  - Uses type definitions from exemption_types.d.ts for Exemption shape.\n *  - Errors are logged to Sentry and then rethrown.\n *  - If `Database.getConnection()` fails, functions return empty arrays.\n *  - Keeps track of exemptions that already exist to avoid duplicates.\n */\n\nimport Database from '@controllers/DBController/DBController';\nimport ExemptionTypes from '@controllers/exemptionController/exemption_types';\nimport { randomUUID } from 'crypto';\nimport * as Sentry from '@sentry/node';\n\n/**\n * Creates exemptions for a list of courses for a specific user.\n * Exemptions mean the user does not need to take those courses.\n * @param {string[]} coursecodes - Array of course codes for which exemptions are to be created.\n * @param {string} user_id - The ID of the user for whom the exemptions are created.\n * @returns {Promise<{ created: ExemptionTypes.Exemption[]; alreadyExists: string[] }>} - An object containing a list of created exemptions and a list of course codes that already have exemptions.\n */\nasync function createExemptions(\n  coursecodes: string[],\n  user_id: string,\n): Promise<{ created: ExemptionTypes.Exemption[]; alreadyExists: string[] }> {\n  const conn = await Database.getConnection();\n  const createdExemptions: ExemptionTypes.Exemption[] = [];\n  const alreadyExists: string[] = [];\n\n  if (conn) {\n    try {\n      // Step 1: Confirm the user exists before creating exemptions for them.\n      const existingUser = await conn\n        .request()\n        .input('id', Database.msSQL.VarChar, user_id)\n        .query('SELECT * FROM AppUser WHERE id = @id');\n\n      if (existingUser.recordset.length === 0) {\n        throw new Error(`AppUser with id '${user_id}' does not exist.`);\n      }\n\n      // Step 2: Loop through each course code provided.\n      for (const coursecode of coursecodes) {\n        // Check if the course exists\n        const existingCourse = await conn\n          .request()\n          .input('code', Database.msSQL.VarChar, coursecode)\n          .query('SELECT * FROM Course WHERE code = @code');\n\n        if (existingCourse.recordset.length === 0) {\n          throw new Error(`Course with code '${coursecode}' does not exist.`);\n        }\n\n        // Check if the exemption already exists for this user + course.\n        const existingExemption = await conn\n          .request()\n          .input('coursecode', Database.msSQL.VarChar, coursecode)\n          .input('user_id', Database.msSQL.VarChar, user_id)\n          .query(\n            'SELECT * FROM Exemption WHERE coursecode = @coursecode AND user_id = @user_id',\n          );\n\n        if (existingExemption.recordset.length > 0) {\n          // Instead of throwing an error, add the coursecode to the alreadyExists array and continue.\n          alreadyExists.push(coursecode);\n          continue;\n        }\n\n        // If it’s a new exemption → create a unique ID.\n        const id = randomUUID();\n\n        // Insert the exemption record into the database.\n        await conn\n          .request()\n          .input('id', Database.msSQL.VarChar, id)\n          .input('coursecode', Database.msSQL.VarChar, coursecode)\n          .input('user_id', Database.msSQL.VarChar, user_id)\n          .query(\n            'INSERT INTO Exemption (id, coursecode, user_id) VALUES (@id, @coursecode, @user_id)',\n          );\n\n        // Add to our \"created\" results array.\n        createdExemptions.push({ id, coursecode, user_id });\n      }\n\n      // Return both the newly created exemptions and the ones that already existed.\n      return { created: createdExemptions, alreadyExists };\n    } catch (error) {\n      Sentry.captureException(error);\n      throw error;\n    } finally {\n      conn.close();\n    }\n  }\n  // In case no connection is made, just return empty arrays.\n  return { created: [], alreadyExists: [] };\n}\n\n/**\n * Retrieves all exemptions associated with a specific user.\n * Useful to display which courses the student doesn’t need to complete.\n *\n * @param {string} user_id - The ID of the user whose exemptions are to be fetched.\n * @returns {Promise<ExemptionTypes.Exemption[] | undefined>} - A list of exemptions associated with the user, or undefined if none found.\n */\nasync function getAllExemptionsByUser(\n  user_id: string,\n): Promise<ExemptionTypes.Exemption[] | undefined> {\n  const conn = await Database.getConnection();\n\n  if (conn) {\n    try {\n      // Check if a appUser exists\n      const existingUser_id = await conn\n        .request()\n        .input('id', Database.msSQL.VarChar, user_id)\n        .query('SELECT * FROM AppUser WHERE id = @id');\n\n      if (existingUser_id.recordset.length === 0) {\n        throw new Error(`AppUser with id '${user_id}' does not exist.`);\n      }\n\n      // Read all exemptions of a user\n      const allExemptions = await conn\n        .request()\n        .input('user_id', Database.msSQL.VarChar, user_id)\n        .query('SELECT * FROM Exemption WHERE user_id = @user_id');\n\n      if (allExemptions.recordset.length === 0) {\n        throw new Error(`No exemptions found for user with id '${user_id}'.`);\n      }\n\n      return allExemptions.recordset;\n    } catch (error) {\n      Sentry.captureException(error);\n      throw error;\n    } finally {\n      conn.close();\n    }\n  }\n}\n/**\n * Deletes an exemption for a specific course and user.\n * Used when an exemption was wrongly added or revoked.\n * @param {string} coursecode - The course code for which the exemption should be deleted.\n * @param {string} user_id - The ID of the user for whom the exemption is being deleted.\n * @returns {Promise<string | undefined>} - A success message if the exemption was deleted, or undefined if no exemption was found.\n */\nasync function deleteExemptionByCoursecodeAndUserId(\n  coursecode: string,\n  user_id: string,\n): Promise<string | undefined> {\n  const conn = await Database.getConnection();\n\n  if (conn) {\n    try {\n      // Step 1: Check that the exemption exists before trying to delete it.\n      const exemption = await conn\n        .request()\n        .input('coursecode', Database.msSQL.VarChar, coursecode)\n        .input('user_id', Database.msSQL.VarChar, user_id)\n        .query(\n          'SELECT * FROM Exemption WHERE coursecode = @coursecode AND user_id = @user_id',\n        );\n\n      if (exemption.recordset.length === 0) {\n        throw new Error(\n          'Exemption with this coursecode and user_id does not exist.',\n        );\n      }\n\n      // Step 2: Delete the exemption record.\n      await conn\n        .request()\n        .input('coursecode', Database.msSQL.VarChar, coursecode)\n        .input('user_id', Database.msSQL.VarChar, user_id)\n        .query(\n          'DELETE FROM Exemption WHERE coursecode = @coursecode AND user_id = @user_id',\n        );\n\n      // Step 3: Return a success message for logging/UI.\n      return `Exemption with appUser ${user_id} and coursecode ${coursecode} has been successfully deleted.`;\n    } catch (error) {\n      Sentry.captureException(error);\n      throw error;\n    } finally {\n      conn.close();\n    }\n  }\n}\n\n// Group everything in one object for export.\nconst exemptionController = {\n  createExemptions,\n  getAllExemptionsByUser,\n  deleteExemptionByCoursecodeAndUserId,\n};\n\nexport default exemptionController;\n"]}