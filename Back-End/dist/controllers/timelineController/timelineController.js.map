{"version":3,"file":"timelineController.js","sourceRoot":"","sources":["../../../controllers/timelineController/timelineController.ts"],"names":[],"mappings":"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","sourcesContent":["import TimelineTypes from '@controllers/timelineController/timeline_types';\nimport * as Sentry from '@sentry/node';\nimport TimelineRepository from './timelineRepository';\n\nconst log = console.log;\n\n/**\n * Save or update a timeline\n */\nasync function saveTimeline(\n  timeline: TimelineTypes.Timeline,\n): Promise<TimelineTypes.Timeline> {\n  const transaction = await TimelineRepository.startTransaction();\n\n  try {\n    const { user_id, name, degree_id, items } = timeline;\n    if (!user_id || !name || !degree_id) {\n      throw new Error('User ID, timeline name, and degree ID are required');\n    }\n\n    // Upsert timeline metadata\n    const timelineId = await TimelineRepository.upsertTimeline(\n      transaction,\n      timeline,\n    );\n\n    // Remove old timeline items before reinserting\n    await TimelineRepository.deleteTimelineItems(transaction, timelineId);\n\n    // Insert new timeline items\n    await TimelineRepository.insertTimelineItems(\n      transaction,\n      timelineId,\n      items,\n    );\n\n    await transaction.commit();\n\n    return { ...timeline, id: timelineId, last_modified: new Date() };\n  } catch (error) {\n    await transaction.rollback();\n    Sentry.captureException(error);\n    log('Error saving timeline:', error);\n    throw error;\n  }\n}\n\n/**\n * Fetch all timelines for a user\n */\nasync function getTimelinesByUser(\n  user_id: string,\n): Promise<TimelineTypes.Timeline[]> {\n  const transaction = await TimelineRepository.startTransaction();\n\n  try {\n    const timelines = await TimelineRepository.getTimelinesByUser(\n      transaction,\n      user_id,\n    );\n    await transaction.commit();\n    return timelines;\n  } catch (error) {\n    await transaction.rollback();\n    Sentry.captureException(error);\n    log('Error fetching timelines for user:', error);\n    throw error;\n  }\n}\n\n/**\n * Remove a timeline by ID\n */\nasync function removeUserTimeline(\n  timeline_id: string,\n): Promise<{ success: boolean; message: string }> {\n  const transaction = await TimelineRepository.startTransaction();\n\n  try {\n    const deletedCount = await TimelineRepository.deleteTimeline(\n      transaction,\n      timeline_id,\n    );\n    await transaction.commit();\n\n    return deletedCount > 0\n      ? {\n          success: true,\n          message: `Timeline ${timeline_id} deleted successfully`,\n        }\n      : { success: false, message: `Timeline ${timeline_id} not found` };\n  } catch (error) {\n    await transaction.rollback();\n    Sentry.captureException(error);\n    log('Error removing timeline:', error);\n    return {\n      success: false,\n      message: 'Error occurred while deleting timeline.',\n    };\n  }\n}\n\nexport default { saveTimeline, getTimelinesByUser, removeUserTimeline };\n"]}