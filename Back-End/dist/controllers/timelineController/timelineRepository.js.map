{"version":3,"file":"timelineRepository.js","sourceRoot":"","sources":["../../../controllers/timelineController/timelineRepository.ts"],"names":[],"mappings":"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","sourcesContent":["import Database from '@controllers/DBController/DBController';\nimport { v4 as uuidv4 } from 'uuid';\nimport TimelineTypes from './timeline_types';\n\nexport default class TimelineRepository {\n  // Utility to start a transaction\n  static async startTransaction() {\n    const dbConn = await Database.getConnection();\n    if (!dbConn) throw new Error('Failed to establish database connection.');\n    const transaction = dbConn.transaction();\n    await transaction.begin();\n    return transaction;\n  }\n\n  // Find timeline by user_id + name\n  static async findTimelineByUserAndName(\n    transaction: any,\n    user_id: string,\n    name: string,\n  ) {\n    return transaction\n      .request()\n      .input('user_id', Database.msSQL.VarChar, user_id)\n      .input('name', Database.msSQL.VarChar, name)\n      .query(\n        `SELECT id FROM Timeline WHERE user_id = @user_id AND name = @name`,\n      );\n  }\n\n  // Upsert timeline metadata\n  static async upsertTimeline(\n    transaction: any,\n    timeline: TimelineTypes.Timeline,\n  ): Promise<string> {\n    const { user_id, name, degree_id, isExtendedCredit } = timeline;\n    const lastModified = new Date();\n    const existing = await this.findTimelineByUserAndName(\n      transaction,\n      user_id,\n      name,\n    );\n\n    if (existing.recordset.length > 0) {\n      const timelineId = existing.recordset[0].id;\n      await transaction\n        .request()\n        .input('timelineId', Database.msSQL.VarChar, timelineId)\n        .input('lastModified', Database.msSQL.DateTime, lastModified)\n        .input('degree_id', Database.msSQL.VarChar, degree_id)\n        .input('isExtendedCredit', Database.msSQL.Bit, isExtendedCredit)\n        .query(\n          `UPDATE Timeline \n           SET last_modified = @lastModified, degree_id = @degree_id, isExtendedCredit = @isExtendedCredit\n           WHERE id = @timelineId`,\n        );\n      return timelineId;\n    } else {\n      const timelineId = uuidv4();\n      await transaction\n        .request()\n        .input('id', Database.msSQL.VarChar, timelineId)\n        .input('user_id', Database.msSQL.VarChar, user_id)\n        .input('degree_id', Database.msSQL.VarChar, degree_id)\n        .input('name', Database.msSQL.VarChar, name)\n        .input('lastModified', Database.msSQL.DateTime, lastModified)\n        .input('isExtendedCredit', Database.msSQL.Bit, isExtendedCredit)\n        .query(\n          `INSERT INTO Timeline (id, user_id, degree_id, name, last_modified, isExtendedCredit)\n           VALUES (@id, @user_id, @degree_id, @name, @lastModified, @isExtendedCredit)`,\n        );\n      return timelineId;\n    }\n  }\n\n  // Delete timeline items and their courses\n  static async deleteTimelineItems(transaction: any, timelineId: string) {\n    const itemsResult = await transaction\n      .request()\n      .input('timelineId', Database.msSQL.VarChar, timelineId)\n      .query(`SELECT id FROM TimelineItems WHERE timeline_id = @timelineId`);\n\n    const timelineItemIds = itemsResult.recordset.map((i: any) => i.id);\n    if (timelineItemIds.length === 0) return;\n\n    // Delete linked courses\n    await transaction\n      .request()\n      .query(\n        `DELETE FROM TimelineItemXCourses WHERE timeline_item_id IN (${timelineItemIds\n          .map((id: string) => `'${id}'`)\n          .join(',')})`,\n      );\n\n    // Delete items\n    await transaction\n      .request()\n      .input('timelineId', Database.msSQL.VarChar, timelineId)\n      .query(`DELETE FROM TimelineItems WHERE timeline_id = @timelineId`);\n  }\n\n  // Insert a single timeline item + its courses\n  static async insertTimelineItem(\n    transaction: any,\n    timelineId: string,\n    item: TimelineTypes.TimelineItem,\n  ) {\n    const timelineItemId = uuidv4();\n    await transaction\n      .request()\n      .input('id', Database.msSQL.VarChar, timelineItemId)\n      .input('timelineId', Database.msSQL.VarChar, timelineId)\n      .input('season', Database.msSQL.VarChar, item.season)\n      .input('year', Database.msSQL.Int, item.year)\n      .query(\n        `INSERT INTO TimelineItems (id, timeline_id, season, year) VALUES (@id, @timelineId, @season, @year)`,\n      );\n\n    const uniqueCourses = Array.from(new Set(item.courses));\n    for (const courseCode of uniqueCourses) {\n      await transaction\n        .request()\n        .input('timelineItemId', Database.msSQL.VarChar, timelineItemId)\n        .input('courseCode', Database.msSQL.VarChar, courseCode)\n        .query(\n          `INSERT INTO TimelineItemXCourses (timeline_item_id, coursecode) VALUES (@timelineItemId, @courseCode)`,\n        );\n    }\n  }\n\n  // Batch insert timeline items\n  static async insertTimelineItems(\n    transaction: any,\n    timelineId: string,\n    items: TimelineTypes.TimelineItem[],\n  ) {\n    for (const item of items) {\n      await this.insertTimelineItem(transaction, timelineId, item);\n    }\n  }\n\n  // Fetch all timelines for a user, including items and courses\n  static async getTimelinesByUser(\n    transaction: any,\n    user_id: string,\n  ): Promise<TimelineTypes.Timeline[]> {\n    const result = await transaction\n      .request()\n      .input('user_id', Database.msSQL.VarChar, user_id).query(`\n        SELECT t.id, t.user_id, t.degree_id, t.name, t.last_modified, t.isExtendedCredit,\n               ti.id AS itemId, ti.season, ti.year, tic.coursecode\n        FROM Timeline t\n        LEFT JOIN TimelineItems ti ON t.id = ti.timeline_id\n        LEFT JOIN TimelineItemXCourses tic ON ti.id = tic.timeline_item_id\n        WHERE t.user_id = @user_id\n        ORDER BY ti.year, ti.season\n      `);\n\n    const timelinesMap: { [id: string]: TimelineTypes.Timeline } = {};\n    for (const row of result.recordset) {\n      if (!timelinesMap[row.id]) {\n        timelinesMap[row.id] = {\n          id: row.id,\n          user_id: row.user_id,\n          degree_id: row.degree_id,\n          name: row.name,\n          last_modified: row.last_modified,\n          isExtendedCredit: row.isExtendedCredit,\n          items: [],\n        };\n      }\n      if (row.itemId) {\n        let item = timelinesMap[row.id].items.find((i) => i.id === row.itemId);\n        if (!item) {\n          item = {\n            id: row.itemId,\n            season: row.season,\n            year: row.year,\n            courses: [],\n          };\n          timelinesMap[row.id].items.push(item);\n        }\n        if (row.coursecode) {\n          item.courses.push(row.coursecode);\n        }\n      }\n    }\n\n    return Object.values(timelinesMap);\n  }\n\n  // Delete a timeline\n  static async deleteTimeline(transaction: any, timelineId: string) {\n    const result = await transaction\n      .request()\n      .input('id', Database.msSQL.VarChar, timelineId)\n      .query(`DELETE FROM Timeline OUTPUT DELETED.id WHERE id = @id`);\n    return result.rowsAffected[0];\n  }\n}\n"]}