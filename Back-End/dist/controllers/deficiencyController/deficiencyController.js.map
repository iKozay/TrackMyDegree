{"version":3,"file":"deficiencyController.js","sourceRoot":"","sources":["../../../controllers/deficiencyController/deficiencyController.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Purpose:\n *  - Controller module for the Deficiency table.\n *  - Provides functions to create, read, and delete deficiencies for users and course pools.\n * Notes:\n *  - Uses type definitions from deficiency_types.d.ts for Deficiency shape.\n *  - Errors are logged to Sentry and then rethrown.\n *  - If `Database.getConnection()` fails, functions return undefined silently.\n *  - Ensures no duplicate deficiencies are created.\n */\n\nimport Database from '@controllers/DBController/DBController';\nimport DeficiencyTypes from '@controllers/deficiencyController/deficiency_types';\nimport { randomUUID } from 'crypto';\nimport * as Sentry from '@sentry/node';\n\n/**\n * Creates a new deficiency for a user and coursepool.\n * Deficiencies represent missing credits a student must complete.\n *\n * @param {string} coursepool - The ID of the course pool.\n * @param {string} user_id - The ID of the user.\n * @param {number} creditsRequired - The number of credits required to resolve the deficiency.\n * @returns {Promise<DeficiencyTypes.Deficiency | undefined>} - The created deficiency or undefined if failed.\n */\nasync function createDeficiency(\n  coursepool: string,\n  user_id: string,\n  creditsRequired: number,\n): Promise<DeficiencyTypes.Deficiency | undefined> {\n  const conn = await Database.getConnection();\n\n  if (conn) {\n    try {\n      // Step 1: Check if this deficiency already exists (same coursepool + user).\n      // If yes, we don't create a duplicate â†’ the user should update instead.\n      const existingDeficiency = await conn\n        .request()\n        .input('coursepool', Database.msSQL.VarChar, coursepool)\n        .input('user_id', Database.msSQL.VarChar, user_id)\n        .query(\n          'SELECT * FROM Deficiency WHERE coursepool = @coursepool AND user_id = @user_id',\n        );\n\n      if (existingDeficiency.recordset.length > 0) {\n        throw new Error(\n          'Deficiency with this coursepool and user_id already exists. Please use the update endpoint',\n        );\n      }\n\n      // Step 2: Make sure the course pool actually exists.\n      const existingCoursePool = await conn\n        .request()\n        .input('id', Database.msSQL.VarChar, coursepool)\n        .query('SELECT * FROM CoursePool WHERE id = @id');\n\n      if (existingCoursePool.recordset.length === 0) {\n        throw new Error('CoursePool does not exist.');\n      }\n\n      // Step 3: Make sure the user exists in the system.\n      const existingAppUser = await conn\n        .request()\n        .input('id', Database.msSQL.VarChar, user_id)\n        .query('SELECT * FROM AppUser WHERE id = @id');\n\n      if (existingAppUser.recordset.length === 0) {\n        throw new Error('AppUser does not exist.');\n      }\n\n      // Step 4: Generate a unique ID for this new deficiency.\n      const id = randomUUID();\n\n      // Step 5: Insert the new deficiency into the database.\n      await conn\n        .request()\n        .input('id', Database.msSQL.VarChar, id)\n        .input('coursepool', Database.msSQL.VarChar, coursepool)\n        .input('user_id', Database.msSQL.VarChar, user_id)\n        .input('creditsRequired', Database.msSQL.Int, creditsRequired)\n        .query(\n          'INSERT INTO Deficiency (id, coursepool, user_id, creditsRequired) VALUES (@id, @coursepool, @user_id, @creditsRequired)',\n        );\n\n      // Return the object so the caller knows what was created.\n      return { id, coursepool, user_id, creditsRequired };\n    } catch (error) {\n      // If something goes wrong, capture it with Sentry for monitoring.\n      Sentry.captureException(error);\n      throw error;\n    } finally {\n      conn.close();\n    }\n  }\n}\n\n/**\n * Retrieves all deficiencies for a specific user.\n * This allows us to see which course pools still require credits.\n *\n * @param {string} user_id - The ID of the user.\n * @returns {Promise<DeficiencyTypes.Deficiency[] | undefined>} - List of deficiencies or undefined if not found.\n */\nasync function getAllDeficienciesByUser(\n  user_id: string,\n): Promise<DeficiencyTypes.Deficiency[] | undefined> {\n  const conn = await Database.getConnection();\n\n  if (conn) {\n    try {\n      // First, confirm that the user exists in the system.\n      const existingAppUser = await conn\n        .request()\n        .input('id', Database.msSQL.VarChar, user_id)\n        .query('SELECT * FROM AppUser WHERE id = @id');\n\n      if (existingAppUser.recordset.length === 0) {\n        throw new Error('AppUser does not exist.');\n      }\n\n      // Fetch all deficiencies tied to this user.\n      const allDeficiencies = await conn\n        .request()\n        .input('user_id', Database.msSQL.VarChar, user_id)\n        .query('SELECT * FROM Deficiency WHERE user_id = @user_id');\n\n      // Return the list if found, otherwise undefined.\n      return allDeficiencies.recordset.length > 0\n        ? allDeficiencies.recordset\n        : undefined;\n    } catch (error) {\n      Sentry.captureException(error);\n      throw error;\n    } finally {\n      conn.close();\n    }\n  }\n}\n/**\n * Deletes a deficiency based on course pool and user ID.\n * Useful if the deficiency is resolved or was created by mistake.\n *\n * @param {string} coursepool - The ID of the course pool.\n * @param {string} user_id - The ID of the user.\n * @returns {Promise<string | undefined>} - Success message or undefined if deletion fails.\n */\n\nasync function deleteDeficiencyByCoursepoolAndUserId(\n  coursepool: string,\n  user_id: string,\n): Promise<string | undefined> {\n  const conn = await Database.getConnection();\n\n  if (conn) {\n    try {\n      // Step 1: Make sure the deficiency actually exists before deleting.\n      const deficiency = await conn\n        .request()\n        .input('coursepool', Database.msSQL.VarChar, coursepool)\n        .input('user_id', Database.msSQL.VarChar, user_id)\n        .query(\n          'SELECT * FROM Deficiency WHERE coursepool = @coursepool AND user_id = @user_id',\n        );\n\n      if (deficiency.recordset.length === 0) {\n        throw new Error('Deficiency with this id does not exist.');\n      }\n\n      // Step 2: Delete the deficiency record.\n      await conn\n        .request()\n        .input('coursepool', Database.msSQL.VarChar, coursepool)\n        .input('user_id', Database.msSQL.VarChar, user_id)\n        .query(\n          'DELETE FROM Deficiency WHERE coursepool = @coursepool AND user_id = @user_id',\n        );\n\n      // Step 3: Return a success message.\n      return `Deficiency with appUser ${user_id} and coursepool ${coursepool} has been successfully deleted.`;\n    } catch (error) {\n      Sentry.captureException(error);\n      throw error;\n    } finally {\n      conn.close();\n    }\n  }\n}\n\n// Export the functions in a namespace-like object so they can be used elsewhere.\nconst deficiencyController = {\n  createDeficiency,\n  getAllDeficienciesByUser,\n  deleteDeficiencyByCoursepoolAndUserId,\n};\n\nexport default deficiencyController;\n"]}