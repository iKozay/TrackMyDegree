{"version":3,"file":"DBController.js","sourceRoot":"","sources":["../../../controllers/DBController/DBController.ts"],"names":[],"mappings":";AAAA;;;;;;;;;GASG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEH,kDAA0B;AAE1B,oDAA4B;AAC5B,qDAAuC;AACvC,4CAAoB;AAEpB,gBAAM,CAAC,MAAM,EAAE,CAAC,CAAC,4CAA4C;AAE7D,IAAI,WAAW,GAAG,OAAO,CAAC,GAAG,CAAC,mBAAmB,CAAC,CAAC,gDAAgD;AACnG,kEAAkE;AAClE,IAAI,OAAO,CAAC,GAAG,CAAC,wBAAwB,EAAE,CAAC;IACzC,IAAI,CAAC;QACH,WAAW,GAAG,YAAE;aACb,YAAY,CAAC,OAAO,CAAC,GAAG,CAAC,wBAAwB,EAAE,OAAO,CAAC;aAC3D,IAAI,EAAE,CAAC;IACZ,CAAC;IAAC,OAAO,CAAC,EAAE,CAAC;QACX,OAAO,CAAC,KAAK,CAAC,yCAAyC,EAAE,CAAC,CAAC,CAAC;IAC9D,CAAC;AACH,CAAC;AACD,oCAAoC;AACpC,MAAM,SAAS,GAAe;IAC5B,IAAI,EAAE,OAAO,CAAC,GAAG,CAAC,eAAe;IACjC,QAAQ,EAAE,WAAW;IACrB,QAAQ,EAAE,OAAO,CAAC,GAAG,CAAC,mBAAmB;IACzC,MAAM,EAAE,OAAO,CAAC,GAAG,CAAC,eAAe;IACnC,OAAO,EAAE;QACP,OAAO,EAAE,IAAI,EAAE,gBAAgB;QAC/B,sBAAsB,EAAE,IAAI,EAAE,iDAAiD;QAC/E,cAAc,EAAE,KAAK,EAAE,aAAa;KACrC;CACF,CAAC;AAEF;;;GAGG;AACH,KAAK,UAAU,aAAa;IAC1B,IAAI,CAAC;QACH,MAAM,IAAI,GAAG,MAAM,eAAK,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;QAC5C,OAAO,CAAC,GAAG,CAAC,uCAAuC,CAAC,CAAC;QACrD,OAAO,IAAI,CAAC;IACd,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,2EAA2E;QAC3E,MAAM,CAAC,gBAAgB,CAAC,EAAE,KAAK,EAAE,6BAA6B,EAAE,CAAC,CAAC;QAClE,OAAO,CAAC,KAAK,CAAC,6BAA6B,EAAE,KAAK,CAAC,CAAC;IACtD,CAAC;AACH,CAAC;AAED,4CAA4C;AAC5C,0BAA0B;AAC1B,2CAA2C;AAC3C,MAAM,YAAY,GAAG;IACnB,KAAK,EAAL,eAAK;IACL,aAAa;CACd,CAAC;AAEF,kBAAe,YAAY,CAAC","sourcesContent":["/**\n * Purpose:\n *  - Central place to configure and manage the SQL Server database connection.\n *  - Exports a getConnection helper that other controllers call to interact with the DB.\n *  - wraps around the `mssql` library and reads credentials from environment variables.\n * Notes:\n *  - Uses dotenv to load environment variables (SQL_SERVER_USER, PASSWORD, etc.)\n *  - Errors are logged to console and captured by Sentry for monitoring.\n *  - Connection options are set up for both Azure SQL (encrypt: true) and local dev (trustServerCertificate).\n */\n\nimport msSQL from 'mssql';\nimport SQL from '@controllers/DBController/DB_types';\nimport dotenv from 'dotenv';\nimport * as Sentry from '@sentry/node';\nimport fs from 'fs';\n\ndotenv.config(); // load environment variables from .env file\n\nlet sqlPassword = process.env.SQL_SERVER_PASSWORD; // default to env var for backward compatibility\n// if docker secret file is provided, read the password from there\nif (process.env.SQL_SERVER_PASSWORD_FILE) {\n  try {\n    sqlPassword = fs\n      .readFileSync(process.env.SQL_SERVER_PASSWORD_FILE, 'utf-8')\n      .trim();\n  } catch (e) {\n    console.error('Error reading SQL_SERVER_PASSWORD_FILE:', e);\n  }\n}\n// Database connection configuration\nconst sqlConfig: SQL.Config = {\n  user: process.env.SQL_SERVER_USER,\n  password: sqlPassword,\n  database: process.env.SQL_SERVER_DATABASE,\n  server: process.env.SQL_SERVER_HOST,\n  options: {\n    encrypt: true, // for Azure SQL\n    trustServerCertificate: true, // change to true for local dev/self-signed certs\n    requestTimeout: 30000, // 30 seconds\n  },\n};\n\n/**\n * Establish connection to the SQL Server database\n * @returns A promise of a msSQL ConnectionPool object, or throws an error with undefined\n */\nasync function getConnection(): Promise<msSQL.ConnectionPool | undefined> {\n  try {\n    const pool = await msSQL.connect(sqlConfig);\n    console.log('Connected to SQL Server successfully!');\n    return pool;\n  } catch (error) {\n    // these below logs to both Sentry and console for debugging and monitoring\n    Sentry.captureException({ error: 'Database connection failed:' });\n    console.error('Database connection failed:', error);\n  }\n}\n\n// Export the controller object, containing:\n// - the raw msSQL library\n// - the helper to establish DB connections\nconst DBController = {\n  msSQL,\n  getConnection,\n};\n\nexport default DBController;\n"]}