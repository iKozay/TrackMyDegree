{"version":3,"file":"requisiteController.js","sourceRoot":"","sources":["../../../controllers/requisiteController/requisiteController.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Purpose:\n *  - Controller module for the Requisite table.\n *  - Provides functions to create, read, update, and delete course requisites.\n * Notes:\n *  - Uses type definitions from requisite_types.d.ts for Requisite shape.\n *  - Errors are logged to Sentry and then rethrown.\n *  - If `Database.getConnection()` fails, functions return undefined.\n *  - Validates courses exist and prevents duplicate requisites.\n */\n\nimport Database from '@controllers/DBController/DBController';\nimport RequisiteTypes from '@controllers/requisiteController/requisite_types';\nimport { randomUUID } from 'crypto';\nimport * as Sentry from '@sentry/node';\n\nconst SELECT_REQUISITE =\n  'SELECT * FROM Requisite WHERE code1 = @code1 AND code2 = @code2 AND type = @type';\n\n/**\n * Creates a new course requisite if it does not already exist.\n * Throws an error if either course does not exist or the requisite is duplicate.\n */\nasync function createRequisite(\n  code1: string,\n  code2: string,\n  type: RequisiteTypes.RequisiteType,\n): Promise<RequisiteTypes.Requisite | undefined> {\n  const conn = await Database.getConnection();\n\n  if (conn) {\n    try {\n      // Generate a unique ID for this new requisite entry\n\n      const id = randomUUID();\n\n      // Make sure both courses exist in the Course table before linking them\n      const coursesCheck = await conn\n        .request()\n        .input('code1', Database.msSQL.VarChar, code1)\n        .input('code2', Database.msSQL.VarChar, code2).query(`\n          SELECT code\n          FROM Course\n          WHERE code IN (@code1, @code2);\n        `);\n\n      if (coursesCheck.recordset.length < 2) {\n        throw new Error(\n          `One or both courses ('${code1}', '${code2}') do not exist.`,\n        );\n      }\n\n      // Check if this exact course-to-course requisite already exists to avoid duplicates\n      const existingRequisite = await conn\n        .request()\n        .input('code1', Database.msSQL.VarChar, code1)\n        .input('code2', Database.msSQL.VarChar, code2)\n        .input('type', Database.msSQL.VarChar, type)\n        .query(\n          SELECT_REQUISITE,\n        );\n\n      if (existingRequisite.recordset.length > 0) {\n        throw new Error(\n          'Requisite with this combination of courses already exists.',\n        );\n      }\n\n      // Insert the new requisite into the database\n      await conn\n        .request()\n        .input('id', Database.msSQL.VarChar, id)\n        .input('code1', Database.msSQL.VarChar, code1)\n        .input('code2', Database.msSQL.VarChar, code2)\n        .input('type', Database.msSQL.VarChar, type)\n        .query(\n          'INSERT INTO Requisite (id, code1, code2, type) VALUES (@id, @code1, @code2, @type)',\n        );\n\n      return existingRequisite.recordset[0];\n    } catch (error) {\n      Sentry.captureException(error);\n      throw error;\n    } finally {\n      conn.close();\n    }\n  }\n}\n\n// This function fetches requisites for a given course.\n// If code2 and type are also provided, it narrows the search further.\nasync function readRequisite(\n  code1: string,\n  code2?: string, // Make code2 optional\n  type?: RequisiteTypes.RequisiteType, // Make type optional\n): Promise<RequisiteTypes.Requisite[] | undefined> {\n  // Return an array of requisites\n  const conn = await Database.getConnection();\n\n  if (conn) {\n    try {\n      // Validate that code1 actually exists in the Course table\n      const coursesCheck = await conn\n        .request()\n        .input('code1', Database.msSQL.VarChar, code1).query(`\n          SELECT code\n          FROM Course\n          WHERE code = @code1;\n        `);\n\n      if (coursesCheck.recordset.length < 1) {\n        throw new Error(`Course '${code1}' does not exist.`);\n      }\n\n      // If both code2 and type are provided, search using all parameters\n      if (code2 && type) {\n        const existingRequisite = await conn\n          .request()\n          .input('code1', Database.msSQL.VarChar, code1)\n          .input('code2', Database.msSQL.VarChar, code2)\n          .input('type', Database.msSQL.VarChar, type)\n          .query(\n            SELECT_REQUISITE,\n          );\n\n        return existingRequisite.recordset; // Return all matching requisites\n      } else {\n        // Otherwise, return all requisites where code1 is the first course\n        const existingRequisite = await conn\n          .request()\n          .input('code1', Database.msSQL.VarChar, code1)\n          .query('SELECT * FROM Requisite WHERE code1 = @code1');\n\n        return existingRequisite.recordset; // Return all requisites for code1\n      }\n    } catch (error) {\n      Sentry.captureException(error);\n      throw error;\n    } finally {\n      conn.close();\n    }\n  }\n}\n\n// Update an existing requisite with new course and type values\nasync function updateRequisite(\n  code1: string,\n  code2: string,\n  type: RequisiteTypes.RequisiteType,\n): Promise<RequisiteTypes.Requisite | undefined> {\n  const conn = await Database.getConnection();\n\n  if (conn) {\n    try {\n      // Confirm both courses exist before updating\n      const coursesCheck = await conn\n        .request()\n        .input('code1', Database.msSQL.VarChar, code1)\n        .input('code2', Database.msSQL.VarChar, code2).query(`\n          SELECT code\n          FROM Course\n          WHERE code IN (@code1, @code2);\n        `);\n\n      if (coursesCheck.recordset.length < 2) {\n        throw new Error(\n          `One or both courses ('${code1}', '${code2}') do not exist.`,\n        );\n      }\n\n      // Check if the new combination already exists to prevent duplicates\n      const existingRequisite = await conn\n        .request()\n        .input('code1', Database.msSQL.VarChar, code1)\n        .input('code2', Database.msSQL.VarChar, code2)\n        .input('type', Database.msSQL.VarChar, type)\n        .query(\n          SELECT_REQUISITE,\n        );\n\n      if (existingRequisite.recordset.length > 0) {\n        throw new Error(\n          'Requisite with this combination of courses already exists.',\n        );\n      }\n\n      // Update the requisite with the new attributes\n      // Perform the update on the Requisite table\n      await conn\n        .request()\n        .input('code1', Database.msSQL.VarChar, code1)\n        .input('code2', Database.msSQL.VarChar, code2)\n        .input('type', Database.msSQL.VarChar, type)\n        .query(\n          'UPDATE Requisite SET code1 = @code1, code2 = @code2, type = @type WHERE id = @id',\n        );\n\n      // Return the updated requisite\n      // Fetch and return the updated requisite entry\n      const updatedRequisite = await conn\n        .request()\n        .input('code1', Database.msSQL.VarChar, code1)\n        .input('code2', Database.msSQL.VarChar, code2)\n        .input('type', Database.msSQL.VarChar, type)\n        .query(\n          SELECT_REQUISITE,\n        );\n\n      return updatedRequisite.recordset[0];\n    } catch (error) {\n      Sentry.captureException(error);\n      throw error;\n    } finally {\n      conn.close();\n    }\n  }\n}\n\n// Delete a requisite if it exists for the given course combination and type\nasync function deleteRequisite(\n  code1: string,\n  code2: string,\n  type: RequisiteTypes.RequisiteType,\n): Promise<string | undefined> {\n  const conn = await Database.getConnection();\n\n  if (conn) {\n    try {\n      // First, check if this requisite actually exists\n      const requisite = await conn\n        .request()\n        .input('code1', Database.msSQL.VarChar, code1)\n        .input('code2', Database.msSQL.VarChar, code2)\n        .input('type', Database.msSQL.VarChar, type)\n        .query(\n          SELECT_REQUISITE,\n        );\n\n      if (requisite.recordset.length === 0) {\n        throw new Error('Requisite with this id does not exist.');\n      }\n\n      // If it exists, delete the entry from the table\n      await conn\n        .request()\n        .input('code1', Database.msSQL.VarChar, code1)\n        .input('code2', Database.msSQL.VarChar, code2)\n        .input('type', Database.msSQL.VarChar, type)\n        .query(\n          'DELETE FROM Requisite WHERE code1 = @code1 AND code2 = @code2 AND type = @type',\n        );\n\n      // Confirm deletion with a success message\n      return `Requisite with the course combination provided has been successfully deleted.`;\n    } catch (error) {\n      Sentry.captureException(error);\n      throw error;\n    } finally {\n      conn.close();\n    }\n  }\n}\n\n//Namespace\nconst requisiteController = {\n  createRequisite,\n  readRequisite,\n  updateRequisite,\n  deleteRequisite,\n};\n\nexport default requisiteController;\n"]}