{"version":3,"file":"userDataController.js","sourceRoot":"","sources":["../../../controllers/userDataController/userDataController.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Purpose:\n *  - Controller module to fetch comprehensive user data.\n *  - Combines user profile, timeline, deficiencies, exemptions, and degree info.\n * Notes:\n *  - Errors are logged to Sentry and returned as 500 Internal Server Error.\n *  - If `Database.getConnection()` fails, returns 500 immediately.\n *  - Checks that user exists and returns 404 if not found.\n */\n\nimport { Request, Response } from 'express';\nimport Database from '@controllers/DBController/DBController';\nimport { UserDataResponse } from './user_data_types';\nimport * as Sentry from '@sentry/node';\n\n// Extract user ID from the request body\nexport const getUserData = async (\n  req: Request,\n  res: Response,\n): Promise<void> => {\n  const { id } = req.body;\n\n  // If no user ID is provided, return a 400 Bad Request response\n  if (!id) {\n    res.status(400).json({ message: 'User ID is required' });\n    return;\n  }\n\n  // Attempt to connect to the database\n  const conn = await Database.getConnection();\n\n  // If connection fails, log the issue to Sentry and return 500 Internal Server Error\n  if (!conn) {\n    res.status(500).json({ message: 'Database connection failed' });\n    Sentry.captureMessage('Database connection failed');\n    return;\n  }\n\n  try {\n    // Check if the user exists in the AppUser table and retrieve basic profile info\n    const userCheckResult = await conn\n      .request()\n      .input('id', Database.msSQL.VarChar, id)\n      .query(\n        `SELECT id, email, fullname, degree, type \n                 FROM AppUser \n                 WHERE id = @id`,\n      );\n\n    // If no user is found, return 404 Not Found\n    if (userCheckResult.recordset.length === 0) {\n      res.status(404).json({ message: 'User not found' });\n      return;\n    }\n\n    const userData = userCheckResult.recordset[0];\n\n    // Fetch the user's timeline (courses taken per season and year)\n    const timelineResult = await conn\n      .request()\n      .input('id', Database.msSQL.VarChar, id)\n      .query(\n        `SELECT season, year, coursecode \n                 FROM Timeline \n                 WHERE user_id = @id`,\n      );\n\n    // Fetch all deficiencies associated with the user (credits they still need)\n    const deficiencyResult = await conn\n      .request()\n      .input('id', Database.msSQL.VarChar, id)\n      .query(\n        `SELECT coursepool, creditsRequired \n                 FROM Deficiency \n                 WHERE user_id = @id`,\n      );\n\n    // Fetch all exemptions for the user (courses they are exempt from)\n    const exemptionResult = await conn\n      .request()\n      .input('id', Database.msSQL.VarChar, id)\n      .query(\n        `SELECT coursecode \n                 FROM Exemption \n                 WHERE user_id = @id`,\n      );\n\n    // Fetch detailed degree information by joining AppUser and Degree tables\n    const degreeResult = await conn\n      .request()\n      .input('id', Database.msSQL.VarChar, id)\n      .query(\n        `SELECT Degree.id, Degree.name, Degree.totalCredits \n                 FROM AppUser \n                 JOIN Degree ON AppUser.degree = Degree.id \n                 WHERE AppUser.id = @id`,\n      );\n\n    // Combine all retrieved data into a structured response object\n    const response: UserDataResponse = {\n      user: {\n        id: userData.id,\n        email: userData.email,\n        fullname: userData.fullname,\n        type: userData.type,\n        degree: userData.degree, // This is the foreign key ID (may be null)\n      },\n      timeline: timelineResult.recordset,\n      deficiencies: deficiencyResult.recordset,\n      exemptions: exemptionResult.recordset,\n      degree: degreeResult.recordset[0] || null, // Detailed degree info (or null)\n    };\n\n    // Send the structured response back to the client\n    res.status(200).json(response);\n  } catch (error) {\n    // Log and report any unexpected errors, then return 500 Internal Server Error\n    console.error('Error fetching user data:', error);\n    Sentry.captureException(error);\n    res.status(500).json({ message: 'Internal server error' });\n  }\n};\n\nexport default getUserData;\n"]}