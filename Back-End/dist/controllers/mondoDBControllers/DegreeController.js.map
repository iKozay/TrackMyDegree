{"version":3,"file":"DegreeController.js","sourceRoot":"","sources":["../../../controllers/mondoDBControllers/DegreeController.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Provides degree-specific operations with improved error handling and query optimization.\n * Includes course pool and degree-course pool mapping functionality.\n */\n\nimport { BaseMongoController } from './BaseMongoController';\nimport { Degree } from '../../models';\nimport * as Sentry from '@sentry/node';\n\nexport interface DegreeData {\n  _id: string;\n  name: string;\n  totalCredits: number;\n}\n\nexport interface CoursePoolData {\n  _id: string;\n  name: string;\n  creditsRequired?: number;\n  courses?: string[];\n}\n\nexport interface DegreeXCPData {\n  degree_id: string;\n  coursepool_id: string;\n  credits: number;\n}\n\nexport interface CoursePoolInfo {\n  _id: string;\n  name: string;\n  creditsRequired: number;\n  courses: string[];\n}\n\nexport class DegreeController extends BaseMongoController<any> {\n  constructor() {\n    super(Degree, 'Degree');\n  }\n\n  // ==========================\n  // DEGREE OPERATIONS\n  // ==========================\n\n  /**\n   * Get degree by ID\n   */\n  async readDegree(_id: string): Promise<DegreeData> {\n    try {\n      const result = await this.findById(_id, 'name totalCredits');\n\n      if (!result.success) {\n        throw new Error('Degree with this id does not exist.');\n      }\n\n      return {\n        _id: result.data._id,\n        name: result.data.name,\n        totalCredits: result.data.totalCredits,\n      };\n    } catch (error) {\n      this.handleError(error, 'readDegree');\n    }\n  }\n\n  /**\n   * Get all degrees (excluding ECP)\n   */\n  async readAllDegrees(): Promise<DegreeData[]> {\n    try {\n      const result = await this.findAll(\n        { _id: { $ne: 'ECP' } },\n        { select: 'name totalCredits', sort: { name: 1 } },\n      );\n\n      if (!result.success) {\n        throw new Error('Failed to fetch degrees');\n      }\n\n      return (result.data || []).map((degree) => ({\n        _id: degree._id,\n        name: degree.name,\n        totalCredits: degree.totalCredits,\n      }));\n    } catch (error) {\n      this.handleError(error, 'readAllDegrees');\n    }\n  }\n\n  /**\n   * Get credits for degree (optimized - only fetches totalCredits field)\n   */\n  async getCreditsForDegree(_id: string): Promise<number> {\n    try {\n      const result = await this.findById(_id, 'totalCredits');\n\n      if (!result.success) {\n        throw new Error('Degree with this id does not exist.');\n      }\n\n      return result.data.totalCredits;\n    } catch (error) {\n      this.handleError(error, 'getCreditsForDegree');\n    }\n  }\n\n  // ==========================\n  // COURSE POOL OPERATIONS\n  // ==========================\n\n  /**\n   * Get all course pools from all degrees (aggregated and deduplicated)\n   */\n  async getAllCoursePools(): Promise<CoursePoolData[]> {\n    try {\n      const result = await this.aggregate<CoursePoolData>([\n        { $unwind: '$coursePools' },\n        {\n          $group: {\n            _id: '$coursePools._id',\n            name: { $first: '$coursePools.name' },\n            creditsRequired: { $first: '$coursePools.creditsRequired' },\n          },\n        },\n        {\n          $project: {\n            _id: '$_id',\n            name: 1,\n            creditsRequired: 1,\n          },\n        },\n        { $sort: { name: 1 } },\n      ]);\n\n      return result.data || [];\n    } catch (error) {\n      Sentry.captureException(error);\n      console.error(\n        '[DegreeController] Error fetching all course pools:',\n        error,\n      );\n      return [];\n    }\n  }\n\n  /**\n   * Get a specific course pool by ID\n   */\n  async getCoursePool(pool_id: string): Promise<CoursePoolData | undefined> {\n    try {\n      const result = await this.aggregate<CoursePoolData>([\n        { $unwind: '$coursePools' },\n        { $match: { 'coursePools._id': pool_id } },\n        {\n          $project: {\n            _id: '$coursePools._id',\n            name: '$coursePools.name',\n            creditsRequired: '$coursePools.creditsRequired',\n            courses: '$coursePools.courses',\n          },\n        },\n        { $limit: 1 },\n      ]);\n\n      return result.data?.[0];\n    } catch (error) {\n      Sentry.captureException(error);\n      console.error('[DegreeController] Error fetching course pool:', error);\n      return undefined;\n    }\n  }\n\n  /**\n   * Get all course pools for a specific degree\n   */\n  async getCoursePoolsByDegree(degree_id: string): Promise<CoursePoolData[]> {\n    try {\n      const degree = await Degree.findById(degree_id)\n        .select('coursePools')\n        .lean()\n        .exec();\n\n      if (!degree || !degree.coursePools) {\n        return [];\n      }\n\n      return degree.coursePools.map((cp: any) => ({\n        _id: cp._id,\n        name: cp.name,\n        creditsRequired: cp.creditsRequired,\n        courses: cp.courses,\n      }));\n    } catch (error) {\n      Sentry.captureException(error);\n      console.error(\n        '[DegreeController] Error fetching degree course pools:',\n        error,\n      );\n      return [];\n    }\n  }\n}\n\nexport const degreeController = new DegreeController();\n"]}