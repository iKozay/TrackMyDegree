{"version":3,"file":"CourseController.js","sourceRoot":"","sources":["../../../controllers/mondoDBControllers/CourseController.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Provides course-specific operations using MongoDB.\n * Includes requisite (prerequisites/corequisites) functionality.\n * Decoupled from Express for better reusability.\n */\n\nimport { BaseMongoController } from './BaseMongoController';\nimport { Course } from '../../models';\n\nexport interface CourseData {\n  _id: string;\n  code?: string;\n  title: string;\n  description?: string;\n  credits: number;\n  prerequisites?: string[];\n  corequisites?: string[];\n  offeredIn?: string[];\n  [key: string]: unknown;\n}\n\nexport type RequisiteType = 'pre' | 'co';\n\nexport interface RequisiteData {\n  code1: string;\n  code2: string;\n  type: RequisiteType;\n}\n\nexport class CourseController extends BaseMongoController<any> {\n  constructor() {\n    super(Course, 'Course');\n  }\n\n  // ==========================\n  // COURSE OPERATIONS\n  // ==========================\n\n  /**\n   * Get all courses with optional filtering and pagination\n   */\n  async getAllCourses(\n    params: {\n      pool?: string;\n      search?: string;\n      page?: number;\n      limit?: number;\n      sort?: string;\n    } = {},\n  ) {\n    try {\n      const { pool, search, page, limit, sort } = params;\n\n      const filter: Record<string, unknown> = {};\n      if (pool) {\n        filter.offeredIn = pool;\n      }\n\n      const options = {\n        page,\n        limit,\n        sort: sort ? { [sort]: 1 as const } : { title: 1 as const },\n        search,\n        fields: ['title', 'description', '_id'],\n      };\n\n      const result = await this.findAll(filter, options);\n      return result.data || [];\n    } catch (error) {\n      this.handleError(error, 'getAllCourses');\n    }\n  }\n\n  /**\n   * Get course by code\n   */\n  async getCourseByCode(code: string) {\n    try {\n      const result = await this.findById(code);\n\n      if (!result.success) {\n        throw new Error(result.error || 'Course not found');\n      }\n\n      return result.data;\n    } catch (error) {\n      this.handleError(error, 'getCourseByCode');\n    }\n  }\n\n  /**\n   * Get courses by pool\n   */\n  async getCoursesByPool(poolName: string) {\n    try {\n      const result = await this.findAll({ offeredIn: poolName });\n\n      if (!result.success) {\n        throw new Error(result.error || 'Failed to fetch courses');\n      }\n\n      return result.data || [];\n    } catch (error) {\n      this.handleError(error, 'getCoursesByPool');\n    }\n  }\n\n  // ==========================\n  // REQUISITE OPERATIONS\n  // ==========================\n\n  /**\n   * Create a new course requisite\n   */\n  async createRequisite(\n    code1: string,\n    code2: string,\n    type: RequisiteType,\n  ): Promise<RequisiteData> {\n    try {\n      // Validate both courses exist (parallel query)\n      const [exists1, exists2] = await Promise.all([\n        Course.exists({ _id: code1 }).exec(),\n        Course.exists({ _id: code2 }).exec(),\n      ]);\n\n      if (!exists1 || !exists2) {\n        throw new Error(\n          `One or both courses ('${code1}', '${code2}') do not exist.`,\n        );\n      }\n\n      const field = type === 'pre' ? 'prerequisites' : 'corequisites';\n\n      // Add requisite atomically (won't add if already exists)\n      const result = await Course.updateOne(\n        { _id: code1 },\n        { $addToSet: { [field]: code2 } },\n      ).exec();\n\n      if (result.modifiedCount === 0) {\n        throw new Error('Requisite already exists or course not found.');\n      }\n\n      return { code1, code2, type };\n    } catch (error) {\n      this.handleError(error, 'createRequisite');\n    }\n  }\n\n  /**\n   * Get all requisites for a course\n   */\n  async getRequisites(code1: string): Promise<RequisiteData[]> {\n    try {\n      const course = await Course.findById(code1)\n        .select('prerequisites corequisites')\n        .lean()\n        .exec();\n\n      if (!course) {\n        throw new Error(`Course '${code1}' does not exist.`);\n      }\n\n      const requisites: RequisiteData[] = [];\n\n      // Add prerequisites\n      (course.prerequisites || []).forEach((code2: string) => {\n        requisites.push({ code1, code2, type: 'pre' });\n      });\n\n      // Add corequisites\n      (course.corequisites || []).forEach((code2: string) => {\n        requisites.push({ code1, code2, type: 'co' });\n      });\n\n      return requisites;\n    } catch (error) {\n      this.handleError(error, 'getRequisites');\n    }\n  }\n\n  /**\n   * Delete a requisite\n   * Optimized with atomic operation\n   */\n  async deleteRequisite(\n    code1: string,\n    code2: string,\n    type: RequisiteType,\n  ): Promise<string> {\n    try {\n      const field = type === 'pre' ? 'prerequisites' : 'corequisites';\n\n      const result = await Course.updateOne(\n        { _id: code1 },\n        { $pull: { [field]: code2 } },\n      ).exec();\n\n      if (result.modifiedCount === 0) {\n        throw new Error('Requisite not found or already deleted.');\n      }\n\n      return `Requisite deleted successfully.`;\n    } catch (error) {\n      this.handleError(error, 'deleteRequisite');\n    }\n  }\n}\n\nexport const courseController = new CourseController();\n"]}