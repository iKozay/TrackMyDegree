{"version":3,"file":"AuthController.js","sourceRoot":"","sources":["../../../controllers/mondoDBControllers/AuthController.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Handles authentication operations with improved error handling and security.\n */\n\nimport { User } from '../../models';\nimport bcrypt from 'bcryptjs';\nimport * as Sentry from '@sentry/node';\nimport { v4 as uuidv4 } from 'uuid';\nimport nodemailer from 'nodemailer';\nimport Redis from 'ioredis';\nimport { randomInt } from 'crypto';\nimport mongoose from 'mongoose';\n\n// Mocro : create Redis client for storing password reset tokens temporarily\nconst redis = new Redis(process.env.REDIS_URL || 'redis://localhost:6379');\n\n\nexport enum UserType {\n  STUDENT = 'student',\n  ADVISOR = 'advisor',\n  ADMIN = 'admin',\n}\n\nexport interface Credentials {\n  email: string;\n  password: string;\n}\n\nexport interface UserInfo extends Credentials {\n  _id: string;\n  fullname: string;\n  type: UserType;\n}\n\nexport interface PasswordResetRequest {\n  email: string;\n  resetToken?: string;\n  newPassword?: string;\n}\n\nexport class AuthController {\n  private readonly RESET_EXPIRY_MINUTES = 10;\n  private readonly DUMMY_HASH = '$2a$10$invalidsaltinvalidsaltinv';\n\n  /**\n   * Authenticates a user by verifying their email and password\n   * Prevents timing attacks by using a dummy hash when user not found\n   */\n  async authenticate(email: string, password: string): Promise<UserInfo | undefined> {\n    try {\n      const user = await User.findOne({ email }).select('+password').lean().exec();\n\n      const hash = user ? user.password : this.DUMMY_HASH;\n      const passwordMatch = await bcrypt.compare(password, hash);\n\n      if (user && passwordMatch && user._id) {\n        return {\n          _id: user._id.toString(),\n          fullname: user.fullname,\n          email: user.email,\n          type: user.type as UserType,\n          password: '',\n        };\n      }\n\n      return undefined;\n    } catch (error) {\n      Sentry.captureException(error, { tags: { operation: 'authenticate' } });\n      console.error('[AuthController] Authentication error');\n      return undefined;\n    }\n  }\n\n  /**\n   * Registers a new user after validating input\n   */\n  async registerUser(userInfo: UserInfo): Promise<{ _id: string } | undefined> {\n    const { email, password, fullname, type } = userInfo;\n\n    try {\n      const existingUser = await User.exists({ email }).exec();\n      if (existingUser) return undefined;\n\n      const newUser = await User.create({ email, password, fullname, type });\n      if (!newUser._id) return undefined;\n\n      return { _id: newUser._id.toString() };\n    } catch (error) {\n      Sentry.captureException(error, { tags: { operation: 'registerUser' } });\n      console.error('[AuthController] Registration error');\n      return undefined;\n    }\n  }\n\n  /**\n   * Sends a secure password reset link via email and stores the token in Redis\n   */\n  async forgotPassword(email: string): Promise<{ message: string; resetLink?: string }> {\n    try {\n      const user = await User.findOne({ email }).exec();\n      if (!user) {\n        // Mocro : Always return generic message to prevent user enumeration\n        return { message: 'If the email exists, a reset link has been sent.' };\n      }\n\n      const resetToken = uuidv4();\n\n      const frontendUrl = process.env.FRONTEND_URL || process.env.CLIENT;\n      if (!frontendUrl) {\n        throw new Error('FRONTEND_URL or CLIENT environment variable is not defined');\n      }\n\n      const resetLink = `${frontendUrl.replace(/\\/$/, '')}/reset-password/${resetToken}`;\n      const expireSeconds = this.RESET_EXPIRY_MINUTES * 60;\n\n      // Mocro : Store token in Redis with expiry\n      await redis.setex(`reset:${resetToken}`, expireSeconds, user.email);\n\n      // Mocro : Send reset email\n      await this.sendResetEmail(user.email, resetLink);\n\n      return { message: 'Password reset link sent successfully', resetLink };\n    } catch (error) {\n      Sentry.captureException(error, { tags: { operation: 'forgotPassword' } });\n      console.error('[AuthController] Password reset error', error);\n      return { message: 'An error occurred. Please try again later.' };\n    }\n  }\n\n  /**\n   * Resets a user's password using the token stored in Redis\n   */\n  async resetPassword(resetToken: string, newPassword: string): Promise<boolean> {\n    try {\n      // Mocro : Get email from Redis\n      const email = await redis.get(`reset:${resetToken}`);\n      if (!email) return false; // invalid or expired token\n\n      const user = await User.findOne({ email }).exec();\n      if (!user) return false;\n\n      user.password = newPassword; // already hashed on frontend\n      await user.save();\n\n      // Mocro : Delete used token\n      await redis.del(`reset:${resetToken}`);\n\n      return true;\n    } catch (error) {\n      Sentry.captureException(error, { tags: { operation: 'resetPassword' } });\n      console.error('[AuthController] Password reset error', error);\n      return false;\n    }\n  }\n\n  /**\n   * Change password for authenticated users\n   */\n  async changePassword(userId: string, oldPassword: string, newPassword: string): Promise<boolean> {\n    try {\n      const user = await User.findById(userId).select('+password').exec();\n      if (!user) return false;\n\n      const match = await bcrypt.compare(oldPassword, user.password);\n      if (!match) return false;\n\n      user.password = newPassword; // already hashed\n      await user.save();\n\n      return true;\n    } catch (error) {\n      Sentry.captureException(error, { tags: { operation: 'changePassword' } });\n      console.error('[AuthController] Password change error', error);\n      return false;\n    }\n  }\n\n  /**\n   * Internal helper: sends reset email\n   */\n  private async sendResetEmail(email: string, resetLink: string) {\n    const transporter = nodemailer.createTransport({\n      host: process.env.SMTP_HOST,\n      port: Number(process.env.SMTP_PORT),\n      auth: { user: process.env.SMTP_USER, pass: process.env.SMTP_PASS },\n    });\n\n    await transporter.sendMail({\n      from: process.env.SMTP_FROM,\n      to: email,\n      subject: 'Password Reset Link',\n      text: `Use this link to reset your password: ${resetLink}`,\n      html: `<p>Use this link to reset your password: <a href=\"${resetLink}\">${resetLink}</a></p>`,\n    });\n  }\n}\n\nexport const authController = new AuthController();\n"]}