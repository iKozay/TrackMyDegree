{"version":3,"file":"TimelineController.js","sourceRoot":"","sources":["../../../controllers/mondoDBControllers/TimelineController.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Provides timeline-specific operations with improved performance and consistency.\n */\n\nimport { BaseMongoController } from './BaseMongoController';\nimport { Timeline } from '../../models';\n\nexport interface TimelineData {\n  _id: string;\n  user_id: string;\n  name: string;\n  degree_id: string;\n  items: TimelineItem[];\n  isExtendedCredit: boolean;\n  last_modified?: Date;\n}\n\nexport interface TimelineItem {\n  _id: string;\n  season: 'fall' | 'winter' | 'summer1' | 'summer2' | 'fall/winter' | 'summer';\n  year: number;\n  courses: string[];\n}\n\nexport class TimelineController extends BaseMongoController<any> {\n  constructor() {\n    super(Timeline, 'Timeline');\n  }\n\n  /**\n   * Save or update a timeline (upsert operation)\n   * Optimized with single database operation\n   */\n  async saveTimeline(timeline: TimelineData): Promise<TimelineData> {\n    try {\n      const { user_id, name, degree_id, items, isExtendedCredit } = timeline;\n\n      if (!user_id || !name || !degree_id) {\n        throw new Error('User ID, timeline name, and degree ID are required');\n      }\n\n      // Map API fields (snake_case) to model fields (camelCase)\n      // Ensure items have _id field\n      const mappedItems = (items || []).map((item, index) => ({\n        _id: item._id || `item-${index}`,\n        season: item.season,\n        year: item.year,\n        courses: item.courses || [],\n      }));\n\n      const result = await this.upsert(\n        { userId: user_id, name, degreeId: degree_id },\n        {\n          userId: user_id,\n          name,\n          degreeId: degree_id,\n          items: mappedItems,\n          isExtendedCredit,\n          last_modified: new Date(),\n        },\n      );\n\n      if (!result.success) {\n        throw new Error('Failed to save timeline');\n      }\n\n      return this.formatTimelineResponse(result.data);\n    } catch (error) {\n      this.handleError(error, 'saveTimeline');\n    }\n  }\n\n  /**\n   * Get all timelines for a user\n   */\n  async getTimelinesByUser(user_id: string): Promise<TimelineData[]> {\n    try {\n      const result = await this.findAll(\n        { userId: user_id },\n        { sort: { last_modified: -1 } },\n      );\n\n      if (!result.success) {\n        throw new Error('Failed to fetch timelines');\n      }\n\n      return (result.data || []).map((timeline) =>\n        this.formatTimelineResponse(timeline),\n      );\n    } catch (error) {\n      this.handleError(error, 'getTimelinesByUser');\n    }\n  }\n\n  /**\n   * Get specific timeline by ID\n   */\n  async getTimelineById(timeline_id: string): Promise<TimelineData> {\n    try {\n      const result = await this.findById(timeline_id);\n\n      if (!result.success) {\n        throw new Error('Timeline not found');\n      }\n\n      return this.formatTimelineResponse(result.data);\n    } catch (error) {\n      this.handleError(error, 'getTimelineById');\n    }\n  }\n\n  /**\n   * Update timeline\n   */\n  async updateTimeline(\n    timeline_id: string,\n    updates: Partial<TimelineData>,\n  ): Promise<TimelineData> {\n    try {\n      // Map API fields (snake_case) to model fields (camelCase)\n      const mappedUpdates: any = {\n        last_modified: new Date(),\n      };\n\n      if (updates.user_id !== undefined) {\n        mappedUpdates.userId = updates.user_id;\n      }\n      if (updates.degree_id !== undefined) {\n        mappedUpdates.degreeId = updates.degree_id;\n      }\n      if (updates.name !== undefined) {\n        mappedUpdates.name = updates.name;\n      }\n      if (updates.isExtendedCredit !== undefined) {\n        mappedUpdates.isExtendedCredit = updates.isExtendedCredit;\n      }\n      if (updates.items !== undefined) {\n        // Ensure items have id field\n        mappedUpdates.items = (updates.items || []).map((item, index) => ({\n          _id: item._id,\n          season: item.season,\n          year: item.year,\n          courses: item.courses || [],\n        }));\n      }\n\n      const result = await this.updateById(timeline_id, mappedUpdates);\n\n      if (!result.success) {\n        throw new Error('Timeline not found');\n      }\n\n      return this.formatTimelineResponse(result.data);\n    } catch (error) {\n      this.handleError(error, 'updateTimeline');\n    }\n  }\n\n  /**\n   * Remove a timeline by ID\n   */\n  async removeUserTimeline(\n    timeline_id: string,\n  ): Promise<{ success: boolean; message: string }> {\n    try {\n      const result = await this.deleteById(timeline_id);\n\n      if (!result.success) {\n        return { success: false, message: `Timeline ${timeline_id} not found` };\n      }\n\n      return {\n        success: true,\n        message: `Timeline ${timeline_id} deleted successfully`,\n      };\n    } catch {\n      return {\n        success: false,\n        message: 'Error occurred while deleting timeline.',\n      };\n    }\n  }\n\n  /**\n   * Delete all timelines for a user\n   */\n  async deleteAllUserTimelines(user_id: string): Promise<number> {\n    try {\n      const result = await this.deleteMany({ userId: user_id });\n\n      if (!result.success) {\n        throw new Error('Failed to delete timelines');\n      }\n\n      return result.data || 0;\n    } catch (error) {\n      this.handleError(error, 'deleteAllUserTimelines');\n    }\n  }\n\n  /**\n   * Format timeline response to match expected interface\n   */\n  private formatTimelineResponse(timeline: any): TimelineData {\n    return {\n      _id: timeline._id,\n      user_id: timeline.userId || timeline.user_id,\n      name: timeline.name,\n      degree_id: timeline.degreeId || timeline.degree_id,\n      items: (timeline.items || []).map((item: any) => ({\n        _id: item._id,\n        season: item.season,\n        year: item.year,\n        courses: item.courses || [],\n      })),\n      isExtendedCredit: timeline.isExtendedCredit,\n      last_modified: timeline.last_modified,\n    };\n  }\n}\n\nexport const timelineController = new TimelineController();\n"]}