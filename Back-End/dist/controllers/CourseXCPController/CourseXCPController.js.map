{"version":3,"file":"CourseXCPController.js","sourceRoot":"","sources":["../../../controllers/CourseXCPController/CourseXCPController.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Purpose:\n *  - Small helper/controller module that talks to the CourseXCoursePool (long for XCP part) table.\n *    Provides functions to create, read, update and delete the mapping between\n *    courses and course pools.\n *\n * Notes:\n *  - Functions return a DB_OPS enum indicating high-level outcome\n *  - Errors are logged with console.log and sent to Sentry for monitoring.\n *  - They separated types for inputs which are declared in CourseXCP_types.d.ts.\n */\n\nimport Database from '@controllers/DBController/DBController';\nimport CourseXCPTypes from '@controllers/CourseXCPController/CourseXCP_types';\nimport DB_OPS from '@Util/DB_Ops';\nimport { randomUUID } from 'crypto';\nimport * as Sentry from '@sentry/node';\n\nconst log = console.log;\n\n/**\n * Insert a new cours in CoursePool record.\n * - Expects: CourseXCPTypes.CourseXCP { coursecode, coursepool_id, group_id }\n * - Reults in inserting a row in CourseXCoursePool.\n * - Returns: DB_OPS.SUCCESS / DB_OPS.MOSTLY_OK / DB_OPS.FAILURE\n */\nasync function createCourseXCP(\n  new_record: CourseXCPTypes.CourseXCP,\n): Promise<DB_OPS> {\n  const dbConn = await Database.getConnection();\n\n  if (dbConn) {\n    const { coursecode, coursepool_id, group_id } = new_record;\n    const record_id = randomUUID();\n\n    try {\n      const result = await dbConn\n        .request()\n        .input('id', Database.msSQL.VarChar, record_id)\n        .input('coursecode', Database.msSQL.VarChar, coursecode)\n        .input('coursepool', Database.msSQL.VarChar, coursepool_id)\n        // The `|| ''` here doesnt really change the type and is confusing â€” it ends up using the DB type\n        .input('group_id', Database.msSQL.VarChar || '', group_id)\n        .query(\n          'INSERT INTO CourseXCoursePool \\\n              ( id, coursecode, coursepool, group_id )\\\n              OUTPUT INSERTED.id\\\n              VALUES\\\n              (@id, @coursecode, @coursepool, @group_id)',\n        );\n\n      if (undefined === result.recordset) {\n        // INSERT ran but didnt return the inserted id for some reason\n        log('Error inserting courseXcoursepool record: ' + result.recordset);\n        Sentry.captureMessage(\n          'Error inserting courseXcoursepool record: ' + result.recordset,\n        );\n        return DB_OPS.MOSTLY_OK;\n      } else {\n        return DB_OPS.SUCCESS;\n      }\n    } catch (error) {\n      Sentry.captureException(error);\n      log('Error in courseXcoursepool creation\\n', error);\n    }\n  }\n\n  return DB_OPS.FAILURE;\n}\n\n/**\n * Fetch all course codes for a given course pool id\n * - Input: coursepool_id (string)\n * - Output: { course_codes: string[] } on success, or undefined on error\n */\nasync function getAllCourseXCP(\n  coursepool_id: string,\n): Promise<{ course_codes: string[] } | undefined> {\n  const dbConn = await Database.getConnection();\n\n  if (dbConn) {\n    try {\n      const result = await dbConn\n        .request()\n        .input('coursepool', Database.msSQL.VarChar, coursepool_id)\n        .query(\n          'SELECT coursecode FROM CourseXCoursePool\\\n              WHERE coursepool = @coursepool',\n        );\n\n      // this essentially builds a simple array of codes from the returned rows\n      const codes = [];\n      for (let i = 0; i < result.recordset.length; i++) {\n        codes.push(result.recordset[i].coursecode);\n      }\n\n      return {\n        course_codes: codes,\n      };\n    } catch (error) {\n      Sentry.captureException(error);\n      log('Error fetching all course codes for given coursepool id\\n', error);\n    }\n  }\n\n  return undefined;\n}\n\n/**\n * Update existing CourseXCoursePool row.\n * - Expects: CourseXCPTypes.CourseXCPItem { id, coursecode, coursepool_id, group_id }\n * - Results in updating row in DB\n * - Returns: DB_OPS.SUCCESS / DB_OPS.MOSTLY_OK / DB_OPS.FAILURE\n *\n * SET clause in the SQL should have commas between assignments but\n *       As written now, SQL lines seems like they lack commas and might cause  syntax error\n */\nasync function updateCourseXCP(\n  update_record: CourseXCPTypes.CourseXCPItem,\n): Promise<DB_OPS> {\n  const dbConn = await Database.getConnection();\n\n  if (dbConn) {\n    const { id, coursecode, coursepool_id, group_id } = update_record;\n\n    try {\n      const result = await dbConn\n        .request()\n        .input('id', Database.msSQL.VarChar, id)\n        .input('coursecode', Database.msSQL.VarChar, coursecode)\n        .input('coursepool', Database.msSQL.VarChar, coursepool_id)\n        .input('group_id', Database.msSQL.VarChar || '', group_id)\n        .query(\n          'UPDATE CourseXCoursePool  \\\n              SET \\\n                coursecode = @coursecode \\\n                coursepool = @coursepool \\\n                group_id = @group_id \\\n              OUTPUT INSERTED.id \\\n              WHERE   id = @id',\n        );\n\n      if (result.recordset.length > 0 && id === result.recordset[0].id) {\n        return DB_OPS.SUCCESS;\n      } else {\n        return DB_OPS.MOSTLY_OK;\n      }\n    } catch (error) {\n      Sentry.captureException(error);\n      log('Error in updating courseXcoursepool item\\n', error);\n    }\n  }\n\n  return DB_OPS.FAILURE;\n}\n\n/**\n * Delete a CourseXCoursePool mapping\n *\n * - Expects: CourseXCPTypes.CourseXCP { coursecode, coursepool_id, group_id }\n * - Results in deletng row(s) in the DB and retrns deleted.coursecode via OUTPUT.\n * - Returns: DB_OPS enum signaling result\n */\nasync function removeDegreeXCP( // should be removeCourseXCP?? seems confusing\n  delete_record: CourseXCPTypes.CourseXCP,\n): Promise<DB_OPS> {\n  const dbConn = await Database.getConnection();\n\n  if (dbConn) {\n    const { coursecode, coursepool_id, group_id } = delete_record;\n\n    try {\n      const result = await dbConn\n        .request()\n        .input('coursecode', Database.msSQL.VarChar, coursecode)\n        .input('coursepool', Database.msSQL.VarChar, coursepool_id)\n        .input('group_id', Database.msSQL.VarChar || '', group_id)\n        .query(\n          'DELETE FROM CourseXCoursePool\\\n                  OUTPUT DELETED.coursecode\\\n                  WHERE coursecode = @coursecode\\\n                  AND   coursepool = @coursepool\\\n                  AND   group_id = @group_id',\n        );\n\n      if (\n        result.recordset.length > 0 &&\n        result.recordset[0].coursecode === coursecode\n      ) {\n        return DB_OPS.SUCCESS;\n      } else {\n        return DB_OPS.MOSTLY_OK;\n      }\n    } catch (error) {\n      Sentry.captureException(error);\n      log('Error in deleting degreeXcoursepool item\\n', error);\n    }\n  }\n\n  return DB_OPS.FAILURE;\n}\n\n// Exported controller API\nconst CourseXCPController = {\n  createCourseXCP,\n  getAllCourseXCP,\n  updateCourseXCP,\n  removeDegreeXCP,\n};\n\nexport default CourseXCPController;\n"]}