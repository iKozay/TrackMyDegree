{"version":3,"file":"appUserController.js","sourceRoot":"","sources":["../../../controllers/appUserController/appUserController.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Purpose:\n *  - Controller module for the AppUser table.\n *  - Provides functions to update and delete user records.\n * Notes:\n *  - Relies on type definitions from appUser_types.d.ts for AppUser shape and roles\n *  - Errors are logged to Sentry and then rethrown.\n *  - If `Database.getConnection()` fails, functions just return `undefined` silently.\n */\n\nimport Database from '@controllers/DBController/DBController';\nimport appUserTypes from '@controllers/appUserController/appUser_types';\nimport * as Sentry from '@sentry/node';\n\n/**\n * Updates an existing AppUser in the database.\n *\n * @param {string} id - The unique identifier of the user.\n * @param {string} email - The new email of the user.\n * @param {string} password - The new password of the user.\n * @param {string} fullname - The updated full name of the user.\n * @param {string} degree - The updated degree ID associated with the user.\n * @param {appUserTypes.UserType} type - The updated user type (student, advisor, admin).\n * @returns {Promise<appUserTypes.AppUser | undefined>} - The updated user record or undefined if the update fails.\n * @throws {Error} - If the user does not exist or a database error occurs.\n */\n\nconst SELECT_USER_BY_ID = 'SELECT * FROM AppUser WHERE id = @id';\n\nasync function updateAppUser(\n  id: string,\n  email: string,\n  password: string,\n  fullname: string,\n  degree: string,\n  type: appUserTypes.UserType,\n): Promise<appUserTypes.AppUser | undefined> {\n  // Establish a database connection\n  const conn = await Database.getConnection();\n  // consider throwing or returning a specific error value here?\n  if (conn) {\n    try {\n      // Check if an AppUser with the given id exists\n      const appUser = await conn\n        .request()\n        .input('id', Database.msSQL.VarChar, id)\n        .query(SELECT_USER_BY_ID);\n\n      if (appUser.recordset.length === 0) {\n        throw new Error('AppUser with this id does not exist.');\n      }\n\n      // Update the AppUser with the provided values\n      await conn\n        .request()\n        .input('id', Database.msSQL.VarChar, id)\n        .input('email', Database.msSQL.VarChar, email)\n        .input('password', Database.msSQL.VarChar, password)\n        .input('fullname', Database.msSQL.VarChar, fullname)\n        .input('degree', Database.msSQL.VarChar, degree)\n        .input('type', Database.msSQL.VarChar, type)\n        .query(\n          `UPDATE AppUser \n            SET email = @email, \n                password = @password, \n                fullname = @fullname, \n                degree = @degree, \n                type = @type \n            WHERE id = @id`,\n        );\n      // Stores passwords directly on plaintext which could be a security risk here, suggest hashing\n      // Retrieve and return the updated user data\n      const updatedAppUser = await conn\n        .request()\n        .input('id', Database.msSQL.VarChar, id)\n        .query(SELECT_USER_BY_ID);\n\n      return updatedAppUser.recordset[0];\n    } catch (error) {\n      Sentry.captureException(error);\n      throw error; // Rethrow any errors encountered\n    } finally {\n      // I'd suggest consider awaiting it through\n      // `await conn.close();`\n      // ensures the connection is fully closed before this function resolves\n      conn.close(); // Ensure the database connection is closed\n    }\n  }\n}\n\n/**\n * Deletes an AppUser from the database.\n *\n * @param {string} id - The unique identifier of the user to be deleted.\n * @returns {Promise<string | undefined>} - A success message if deletion is successful, or undefined if an error occurs.\n * @throws {Error} - If the user does not exist or a database error occurs.\n */\nasync function deleteAppUser(id: string): Promise<string | undefined> {\n  const conn = await Database.getConnection();\n  // Again, consider throwing or returning a specific error value here\n  if (conn) {\n    try {\n      // Check if an AppUser with the given id exists\n      const appUser = await conn\n        .request()\n        .input('id', Database.msSQL.VarChar, id)\n        .query(SELECT_USER_BY_ID);\n\n      if (appUser.recordset.length === 0) {\n        throw new Error('AppUser with this id does not exist.');\n      }\n\n      // Delete the AppUser from the database\n      await conn\n        .request()\n        .input('id', Database.msSQL.VarChar, id)\n        .query('DELETE FROM AppUser WHERE id = @id');\n\n      // Return success message\n      return `AppUser with id ${id} has been successfully deleted.`;\n    } catch (error) {\n      Sentry.captureException(error);\n      throw error; // Rethrow any errors encountered\n    } finally {\n      // again consider `await conn.close();` to be sure connection has ended\n      conn.close(); // Ensure the database connection is always closed\n    }\n  }\n}\n\n//Namespace\nconst appUserController = {\n  updateAppUser,\n  deleteAppUser,\n};\n\nexport default appUserController;\n"]}