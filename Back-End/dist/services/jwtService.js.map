{"version":3,"file":"jwtService.js","sourceRoot":"","sources":["../../services/jwtService.ts"],"names":[],"mappings":"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","sourcesContent":["import jwt, { SignOptions } from 'jsonwebtoken';\nimport { CookieOptions } from 'express';\nimport Auth from '@controllers/authController/auth_types';\nimport {\n  createSessionToken,\n  refreshSession,\n  SessionToken,\n  UserHeaders,\n} from '@Util/Session_Util';\n\nexport type JWTPayload = {\n  orgId: string;\n  userId: string;\n  type: Auth.UserType;\n};\n\nexport type TokenPayload = JWTPayload & {\n  session_token: SessionToken;\n} & jwt.JwtPayload;\n\nexport type JWTCookieModel = {\n  name: string;\n  value: string;\n  config: CookieOptions;\n};\n\nconst ACCESS_EXPIRY = process.env.JWT_ACCESS_EXPIRY || '1h';\nconst REFRESH_EXPIRY = process.env.JWT_REFRESH_EXPIRY || '7d';\n\nfunction getSecretKey(): string {\n  const secret = process.env.JWT_SECRET;\n  if (!secret) throw new Error('JWT_SECRET not defined');\n  return secret;\n}\n\nfunction parseExpiryToMs(exp: string): number {\n  // Converts \"1h\", \"7d\", etc. to milliseconds\n  const num = parseInt(exp);\n  if (exp.endsWith('h')) return num * 60 * 60 * 1000;\n  if (exp.endsWith('d')) return num * 24 * 60 * 60 * 1000;\n  return num * 1000;\n}\n\nexport function getCookieOptions(isRefresh: boolean = false): CookieOptions {\n  const isProd = process.env.NODE_ENV === 'production';\n\n  return {\n    httpOnly: true,\n    secure: isProd,\n    sameSite: 'strict',\n    path: isRefresh ? '/auth/refresh' : '/',\n    maxAge: isRefresh\n      ? parseExpiryToMs(REFRESH_EXPIRY)\n      : parseExpiryToMs(ACCESS_EXPIRY),\n    domain: isProd ? process.env.COOKIE_DOMAIN : undefined,\n  };\n}\n\nexport const jwtService = {\n  generateToken: (\n    payload: JWTPayload,\n    user: UserHeaders,\n    token?: SessionToken,\n    isRefresh: boolean = false,\n  ): string => {\n    const session_payload = {\n      ...payload,\n      session_token: token\n        ? refreshSession(token, user)\n        : createSessionToken(user),\n    };\n\n    const options: SignOptions = {\n      expiresIn: (isRefresh ? REFRESH_EXPIRY : ACCESS_EXPIRY) as any,\n    };\n\n    return jwt.sign(session_payload, getSecretKey(), options);\n  },\n\n  verifyAccessToken: (token: string): TokenPayload | null => {\n    try {\n      return jwt.verify(token, getSecretKey()) as TokenPayload;\n    } catch {\n      return null;\n    }\n  },\n\n  verifyRefreshToken: (token: string): TokenPayload | null => {\n    try {\n      return jwt.verify(token, getSecretKey()) as TokenPayload;\n    } catch {\n      return null;\n    }\n  },\n\n  setAccessCookie: (token: string): JWTCookieModel => ({\n    name: 'access_token',\n    value: token,\n    config: getCookieOptions(false),\n  }),\n\n  setRefreshCookie: (token: string): JWTCookieModel => ({\n    name: 'refresh_token',\n    value: token,\n    config: getCookieOptions(true),\n  }),\n};\n"]}