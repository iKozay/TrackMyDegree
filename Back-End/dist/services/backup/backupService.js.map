{"version":3,"file":"backupService.js","sourceRoot":"","sources":["../../../services/backup/backupService.ts"],"names":[],"mappings":"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","sourcesContent":["import mongoose from 'mongoose';\nimport fs from 'node:fs';\nimport fsPromises = fs.promises;\nimport path from 'node:path';\nimport * as Sentry from '@sentry/node';\nimport { seedDatabase } from '../seed/seedService';\n\nconst BACKUP_DIR = (\n  process.env.BACKUP_DIR || path.join(__dirname, '../../backups')\n).trim();\n\n// Collections to backup (USER DATA ONLY - excludes courses and degrees)\nconst USER_DATA_COLLECTIONS = ['users', 'timelines', 'feedback'];\n\n// -------------------------------------\n// Ensure Backup Directory Exists\n// -------------------------------------\nasync function ensureBackupDir(): Promise<void> {\n  if (!fs.existsSync(BACKUP_DIR)) {\n    await fsPromises.mkdir(BACKUP_DIR, { recursive: true });\n    console.log(`Created backup directory: ${BACKUP_DIR}`);\n  }\n}\n\n// -------------------------------------\n// Create Backup (User Data Only)\n// -------------------------------------\nexport async function createBackup(): Promise<string> {\n  try {\n    const db = mongoose.connection.db;\n    if (!db) throw new Error('No database connection available');\n\n    await ensureBackupDir();\n\n    const backupData: Record<string, any[]> = {};\n\n    // Only backup user data collections\n    for (const collectionName of USER_DATA_COLLECTIONS) {\n      try {\n        const collection = db.collection(collectionName);\n        const data = await collection.find().toArray();\n        backupData[collectionName] = data;\n        console.log(\n          `Backed up ${data.length} documents from ${collectionName}`,\n        );\n      } catch (error) {\n        // log error for each collection\n        console.warn(\n          `Error accessing collection ${collectionName}:`,\n          (error as Error).message,\n        );\n        backupData[collectionName] = [];\n      }\n    }\n\n    const timestamp = new Date().toISOString().replaceAll(/[:.]/g, '-');\n    const fileName = `backup-${timestamp}.json`;\n    const filePath = path.join(BACKUP_DIR, fileName);\n\n    await fsPromises.writeFile(\n      filePath,\n      JSON.stringify(backupData, null, 2),\n      'utf-8',\n    );\n\n    console.log(`Backup created successfully at: ${filePath}`);\n    return fileName;\n  } catch (error) {\n    Sentry.captureException(error);\n    console.error('Error creating backup:', error);\n    throw error;\n  }\n}\n\n// -------------------------------------\n// List Available Backups\n// -------------------------------------\nexport async function listBackups(): Promise<string[]> {\n  try {\n    await ensureBackupDir();\n    const files = await fsPromises.readdir(BACKUP_DIR);\n    return files.filter((file) => file.endsWith('.json'));\n  } catch (error) {\n    Sentry.captureException(error);\n    console.error('Error listing backups:', error);\n    throw error;\n  }\n}\n\n// -------------------------------------\n// Restore Backup\n// Step 1: Clear ALL collections\n// Step 2: Re-seed Courses & Degrees from files\n// Step 3: Restore User Data from backup\n// -------------------------------------\nexport async function restoreBackup(backupFileName: string): Promise<void> {\n  try {\n    const filePath = path.join(BACKUP_DIR, backupFileName);\n\n    if (!fs.existsSync(filePath)) {\n      throw new Error(`Backup file not found: ${filePath}`);\n    }\n\n    const db = mongoose.connection.db;\n    if (!db) throw new Error('No database connection available');\n\n    // Read backup data\n    const backupContent = await fsPromises.readFile(filePath, 'utf-8');\n    const backupData: Record<string, any[]> = JSON.parse(backupContent);\n\n    console.log('[RESTORE] Step 1: Clearing all collections...');\n\n    const collections = await db.listCollections().toArray();\n    for (const col of collections) {\n      await db.collection(col.name).deleteMany({});\n      console.log(`Cleared collection: ${col.name}`);\n    }\n\n    console.log('[RESTORE] Step 2: Re-seeding Courses & Degrees from files...');\n\n    await seedDatabase();\n\n    console.log('[RESTORE] Step 3: Restoring user data from backup...');\n\n    for (const collectionName of USER_DATA_COLLECTIONS) {\n      const docs = backupData[collectionName];\n\n      if (!docs || !Array.isArray(docs) || docs.length === 0) {\n        console.log(`No data to restore for collection: ${collectionName}`);\n        continue;\n      }\n\n      try {\n        const collection = db.collection(collectionName);\n        await collection.insertMany(docs);\n        console.log(`Restored ${docs.length} documents to ${collectionName}`);\n      } catch (error) {\n        console.error(`Error restoring collection ${collectionName}:`, error);\n        throw error;\n      }\n    }\n\n    console.log(\n      `[RESTORE] Backup restored successfully from: ${backupFileName}`,\n    );\n  } catch (error) {\n    Sentry.captureException(error);\n    console.error('Error restoring backup:', error);\n    throw error;\n  }\n}\n\n// -------------------------------------\n// Delete Backup\n// -------------------------------------\nexport async function deleteBackup(backupFileName: string): Promise<void> {\n  try {\n    const filePath = path.join(BACKUP_DIR, backupFileName);\n\n    if (!fs.existsSync(filePath)) {\n      throw new Error(`Backup file not found: ${backupFileName}`);\n    }\n\n    await fsPromises.unlink(filePath);\n    console.log(`Backup deleted: ${backupFileName}`);\n  } catch (error) {\n    Sentry.captureException(error);\n    console.error('Error deleting backup:', error);\n    throw error;\n  }\n}\n"]}