{"version":3,"file":"session.js","sourceRoot":"","sources":["../../routes/session.ts"],"names":[],"mappings":";;;;;AAAA,sDAAqD;AACrD,kEAAmC;AACnC,4FAA8D;AAC9D,iEAA4D;AAC5D,uDAIgC;AAChC,uDAAiE;AAEjE,MAAM,MAAM,GAAG,iBAAO,CAAC,MAAM,EAAE,CAAC;AAEhC,cAAc;AACd,MAAM,CAAC,GAAG,CAAC,+BAAc,CAAC,CAAC;AAE3B,kBAAkB;AAClB,MAAM,CAAC,GAAG,CAAC,UAAU,EAAE,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IAC3D,MAAM,YAAY,GAAG,GAAG,CAAC,OAAO,CAAC,YAAY,CAAC;IAE9C,IAAI,CAAC;QACH,MAAM,OAAO,GAAgB;YAC3B,KAAK,EAAE,GAAG,CAAC,OAAO,CAAC,YAAY,CAAC,IAAI,EAAE;YACtC,OAAO,EAAE,GAAG,CAAC,EAAE,IAAI,EAAE;SACtB,CAAC;QACF,MAAM,OAAO,GAAiB,uBAAU,CAAC,iBAAiB,CAAC,YAAY,CAAE,CAAC;QAC1E,MAAM,aAAa,GAAG,IAAA,6BAAc,EAAC,OAAO,CAAC,aAAa,EAAE,OAAO,CAAC,CAAC;QAErE,IAAI,CAAC,aAAa,EAAE,CAAC;YACnB,MAAM,IAAI,KAAK,CAAC,cAAc,CAAC,CAAC;QAClC,CAAC;QAED,MAAM,WAAW,GAAG,uBAAU,CAAC,aAAa,CAC1C;YACE,KAAK,EAAE,OAAO,CAAC,GAAG,CAAC,UAAW;YAC9B,MAAM,EAAE,OAAO,CAAC,EAAG;YACnB,IAAI,EAAE,OAAO,CAAC,IAAI;SACnB,EACD,OAAO,EACP,aAAa,CACd,CAAC;QAEF,MAAM,MAAM,GAAG,uBAAU,CAAC,eAAe,CAAC,WAAW,CAAC,CAAC;QAEvD,GAAG,CAAC,WAAW,CAAC,MAAM,CAAC,IAAI,EAAE,IAAA,6BAAgB,GAAE,CAAC,CAAC,CAAC,0BAA0B;QAC5E,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,MAAM,CAAC,KAAK,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,sBAAsB;QAE5E,MAAM,MAAM,GAAG,MAAM,sBAAQ,CAAC,aAAa,EAAE,CAAC;QAE9C,IAAI,MAAM,EAAE,CAAC;YACX,iBAAiB;YACjB,MAAM,MAAM,GAAG,MAAM,MAAM;iBACxB,OAAO,EAAE;iBACT,KAAK,CAAC,IAAI,EAAE,sBAAQ,CAAC,KAAK,CAAC,OAAO,EAAE,OAAO,CAAC,MAAM,CAAC;iBACnD,KAAK,CAAC,sCAAsC,CAAC,CAAC;YAEjD,IAAI,MAAM,CAAC,SAAS,IAAI,MAAM,CAAC,SAAS,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBACpD,GAAG,CAAC,MAAM,CAAC,mBAAI,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC;YAChD,CAAC;iBAAM,CAAC;gBACN,MAAM,IAAI,KAAK,CAAC,gBAAgB,CAAC,CAAC;YACpC,CAAC;QACH,CAAC;QAED,GAAG,CAAC,MAAM,CAAC,mBAAI,CAAC,UAAU,CAAC,CAAC;IAC9B,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,GAAG,CAAC,MAAM,CAAC,mBAAI,CAAC,YAAY,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAG,KAAe,CAAC,OAAO,EAAE,CAAC,CAAC;IAC5E,CAAC;AACH,CAAC,CAAC,CAAC;AAEH,MAAM,CAAC,GAAG,CAAC,UAAU,EAAE,CAAC,GAAY,EAAE,GAAa,EAAE,EAAE;IACrD,GAAG,CAAC,WAAW,CAAC,cAAc,CAAC,CAAC;IAEhC,GAAG,CAAC,MAAM,CAAC,mBAAI,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,mBAAmB,EAAE,CAAC,CAAC;AAC7D,CAAC,CAAC,CAAC;AAEH,kBAAe,MAAM,CAAC","sourcesContent":["import express, { Request, Response } from 'express';\nimport HTTP from '@Util/HTTPCodes';\nimport Database from '@controllers/DBController/DBController';\nimport { authMiddleware } from '@middleware/authMiddleware';\nimport {\n  jwtService,\n  TokenPayload,\n  getCookieOptions,\n} from '../services/jwtService';\nimport { refreshSession, UserHeaders } from '@Util/Session_Util';\n\nconst router = express.Router();\n\n//* Middleware\nrouter.use(authMiddleware);\n\n//* Route handlers\nrouter.get('/refresh', async (req: Request, res: Response) => {\n  const access_token = req.cookies.access_token;\n\n  try {\n    const headers: UserHeaders = {\n      agent: req.headers['user-agent'] || '',\n      ip_addr: req.ip || '',\n    };\n    const payload: TokenPayload = jwtService.verifyAccessToken(access_token)!;\n    const session_token = refreshSession(payload.session_token, headers);\n\n    if (!session_token) {\n      throw new Error('Unauthorized');\n    }\n\n    const accessToken = jwtService.generateToken(\n      {\n        orgId: process.env.JWT_ORG_ID!,\n        userId: payload.id!,\n        type: payload.type,\n      },\n      headers,\n      session_token,\n    );\n\n    const cookie = jwtService.setAccessCookie(accessToken);\n\n    res.clearCookie(cookie.name, getCookieOptions()); //? Clear previous session\n    res.cookie(cookie.name, cookie.value, cookie.config); //? Set new JWT cookie\n\n    const dbConn = await Database.getConnection();\n\n    if (dbConn) {\n      //? Get User Data\n      const result = await dbConn\n        .request()\n        .input('id', Database.msSQL.VarChar, payload.userId)\n        .query('SELECT * FROM AppUser WHERE id = @id');\n\n      if (result.recordset && result.recordset.length > 0) {\n        res.status(HTTP.OK).json(result.recordset[0]);\n      } else {\n        throw new Error('User not found');\n      }\n    }\n\n    res.status(HTTP.SERVER_ERR);\n  } catch (error) {\n    res.status(HTTP.UNAUTHORIZED).json({ message: (error as Error).message });\n  }\n});\n\nrouter.get('/destroy', (req: Request, res: Response) => {\n  res.clearCookie('access_token');\n\n  res.status(HTTP.OK).json({ message: 'session destroyed' });\n});\n\nexport default router;\n"]}