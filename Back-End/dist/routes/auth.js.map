{"version":3,"file":"auth.js","sourceRoot":"","sources":["../../routes/auth.ts"],"names":[],"mappings":";;;;;AAAA,sDAAqD;AACrD,kGAAwE;AACxE,kEAAmC;AAEnC,wDAA8B;AAC9B,oDAA4B;AAC5B,uDAAoD;AACpD,uDAAgE;AAEhE,gBAAM,CAAC,MAAM,EAAE,CAAC;AAEhB,MAAM,MAAM,GAAG,iBAAO,CAAC,MAAM,EAAE,CAAC;AAChC,MAAM,IAAI,GAAG,kBAAM,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC;AACpC,MAAM,cAAc,GAAG;IACrB,kBAAkB,EAAE,8BAA8B;IAClD,qBAAqB,EAAE,CAAC,KAAa,EAAE,EAAE,CAAC,4BAA4B,KAAK,EAAE;CACrE,CAAC;AAEX,SAAS,kBAAkB,CAAC,GAAY;IACtC,OAAO;QACL,KAAK,EAAE,GAAG,CAAC,OAAO,CAAC,YAAY,CAAC,IAAI,EAAE;QACtC,OAAO,EAAE,GAAG,CAAC,EAAE,IAAI,EAAE;KACtB,CAAC;AACJ,CAAC;AAED,YAAY;AACZ,QAAQ;AACR,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IAC1D,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,GAAG,CAAC,IAAI,CAAC;IACrC,IAAI,CAAC,KAAK,IAAI,CAAC,QAAQ;QACrB,OAAO,GAAG;aACP,MAAM,CAAC,mBAAI,CAAC,WAAW,CAAC;aACxB,IAAI,CAAC,EAAE,KAAK,EAAE,iCAAiC,EAAE,CAAC,CAAC;IAExD,IAAI,CAAC;QACH,MAAM,IAAI,GAAG,MAAM,wBAAc,CAAC,YAAY,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC;QAChE,IAAI,CAAC,IAAI;YACP,OAAO,GAAG;iBACP,MAAM,CAAC,mBAAI,CAAC,YAAY,CAAC;iBACzB,IAAI,CAAC,EAAE,KAAK,EAAE,6BAA6B,EAAE,CAAC,CAAC;QAEpD,MAAM,WAAW,GAAG,kBAAkB,CAAC,GAAG,CAAC,CAAC;QAC5C,MAAM,WAAW,GAAG,uBAAU,CAAC,aAAa,CAC1C,EAAE,KAAK,EAAE,OAAO,CAAC,GAAG,CAAC,UAAW,EAAE,MAAM,EAAE,IAAI,CAAC,EAAG,EAAE,IAAI,EAAE,IAAI,CAAC,IAAI,EAAE,EACrE,WAAW,CACZ,CAAC;QACF,MAAM,YAAY,GAAG,uBAAU,CAAC,aAAa,CAC3C,EAAE,KAAK,EAAE,OAAO,CAAC,GAAG,CAAC,UAAW,EAAE,MAAM,EAAE,IAAI,CAAC,EAAG,EAAE,IAAI,EAAE,IAAI,CAAC,IAAI,EAAE,EACrE,WAAW,EACX,SAAS,EACT,IAAI,CACL,CAAC;QAEF,MAAM,YAAY,GAAG,uBAAU,CAAC,eAAe,CAAC,WAAW,CAAC,CAAC;QAC7D,MAAM,aAAa,GAAG,uBAAU,CAAC,gBAAgB,CAAC,YAAY,CAAC,CAAC;QAEhE,GAAG,CAAC,MAAM,CAAC,YAAY,CAAC,IAAI,EAAE,YAAY,CAAC,KAAK,EAAE,YAAY,CAAC,MAAM,CAAC,CAAC;QACvE,GAAG,CAAC,MAAM,CAAC,aAAa,CAAC,IAAI,EAAE,aAAa,CAAC,KAAK,EAAE,aAAa,CAAC,MAAM,CAAC,CAAC;QAE1E,GAAG,CAAC,MAAM,CAAC,mBAAI,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IACjC,CAAC;IAAC,OAAO,GAAG,EAAE,CAAC;QACb,GAAG,CAAC,MAAM,CAAC,mBAAI,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,uBAAuB,EAAE,CAAC,CAAC;IACvE,CAAC;AACH,CAAC,CAAC,CAAC;AAEH,UAAU;AACV,MAAM,CAAC,IAAI,CAAC,UAAU,EAAE,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IAC5D,MAAM,KAAK,GAAG,GAAG,CAAC,OAAO,EAAE,aAAa,CAAC;IACzC,MAAM,WAAW,GAAG,kBAAkB,CAAC,GAAG,CAAC,CAAC;IAC5C,IAAI,CAAC,KAAK;QACR,OAAO,GAAG;aACP,MAAM,CAAC,mBAAI,CAAC,YAAY,CAAC;aACzB,IAAI,CAAC,EAAE,KAAK,EAAE,uBAAuB,EAAE,CAAC,CAAC;IAE9C,MAAM,OAAO,GAAG,uBAAU,CAAC,kBAAkB,CAAC,KAAK,CAAC,CAAC;IACrD,IAAI,CAAC,OAAO;QACV,OAAO,GAAG;aACP,MAAM,CAAC,mBAAI,CAAC,YAAY,CAAC;aACzB,IAAI,CAAC,EAAE,KAAK,EAAE,kCAAkC,EAAE,CAAC,CAAC;IAEzD,IACE,OAAO,CAAC,aAAa;QACrB,CAAC,IAAA,4BAAa,EAAC,OAAO,CAAC,aAAa,EAAE,WAAW,CAAC,EAClD,CAAC;QACD,OAAO,GAAG,CAAC,MAAM,CAAC,mBAAI,CAAC,YAAY,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,kBAAkB,EAAE,CAAC,CAAC;IAC3E,CAAC;IAED,MAAM,cAAc,GAAG,uBAAU,CAAC,aAAa,CAC7C,OAAO,EACP,WAAW,EACX,OAAO,CAAC,aAAa,CACtB,CAAC;IACF,MAAM,eAAe,GAAG,uBAAU,CAAC,aAAa,CAC9C,OAAO,EACP,WAAW,EACX,OAAO,CAAC,aAAa,EACrB,IAAI,CACL,CAAC;IAEF,MAAM,YAAY,GAAG,uBAAU,CAAC,eAAe,CAAC,cAAc,CAAC,CAAC;IAChE,MAAM,aAAa,GAAG,uBAAU,CAAC,gBAAgB,CAAC,eAAe,CAAC,CAAC;IAEnE,GAAG,CAAC,MAAM,CAAC,YAAY,CAAC,IAAI,EAAE,YAAY,CAAC,KAAK,EAAE,YAAY,CAAC,MAAM,CAAC,CAAC;IACvE,GAAG,CAAC,MAAM,CAAC,aAAa,CAAC,IAAI,EAAE,aAAa,CAAC,KAAK,EAAE,aAAa,CAAC,MAAM,CAAC,CAAC;IAE1E,GAAG,CAAC,MAAM,CAAC,mBAAI,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,kBAAkB,EAAE,CAAC,CAAC;AAC5D,CAAC,CAAC,CAAC;AAEH,UAAU;AACV,MAAM,CAAC,IAAI,CAAC,SAAS,EAAE,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IAC3D,IAAI,CAAC,GAAG,CAAC,IAAI,IAAI,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;QACpD,GAAG;aACA,MAAM,CAAC,mBAAI,CAAC,WAAW,CAAC;aACxB,IAAI,CAAC,EAAE,KAAK,EAAE,cAAc,CAAC,kBAAkB,EAAE,CAAC,CAAC;QACtD,OAAO;IACT,CAAC;IAED,MAAM,OAAO,GAAkB,GAAG,CAAC,IAAI,CAAC;IAExC,IAAI,CAAC;QACH,MAAM,MAAM,GAAG,MAAM,wBAAc,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC;QAE1D,IAAI,MAAM,EAAE,CAAC;YACX,GAAG,CAAC,MAAM,CAAC,mBAAI,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QACxC,CAAC;aAAM,CAAC;YACN,MAAM,IAAI,KAAK,CAAC,+BAA+B,CAAC,CAAC;QACnD,CAAC;IACH,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,MAAM,MAAM,GAAG,cAAc,CAAC,qBAAqB,CAAC,SAAS,CAAC,CAAC;QAC/D,OAAO,CAAC,KAAK,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;QAC7B,GAAG,CAAC,MAAM,CAAC,mBAAI,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;IACtD,CAAC;AACH,CAAC,CAAC,CAAC;AAEH,kBAAkB;AAClB,MAAM,CAAC,IAAI,CAAC,kBAAkB,EAAE,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IACpE,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,CAAC;QACd,GAAG;aACA,MAAM,CAAC,mBAAI,CAAC,WAAW,CAAC;aACxB,IAAI,CAAC,EAAE,KAAK,EAAE,cAAc,CAAC,kBAAkB,EAAE,CAAC,CAAC;QACtD,OAAO,CAAC,2BAA2B;IACrC,CAAC;IAED,IAAI,KAAK,GAAG,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC;IAE3B,IAAI,CAAC;QACH,MAAM,MAAM,GAAG,MAAM,wBAAc,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC;QAE1D,IAAI,MAAM,EAAE,CAAC;YACX,GAAG,CAAC,MAAM,CAAC,mBAAI,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QACzC,CAAC;aAAM,CAAC;YACN,MAAM,IAAI,KAAK,CAAC,+BAA+B,CAAC,CAAC;QACnD,CAAC;IACH,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,MAAM,MAAM,GAAG,cAAc,CAAC,qBAAqB,CAAC,kBAAkB,CAAC,CAAC;QACxE,OAAO,CAAC,KAAK,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;QAC7B,GAAG,CAAC,MAAM,CAAC,mBAAI,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;IACtD,CAAC;AACH,CAAC,CAAC,CAAC;AAEH,iBAAiB;AACjB,MAAM,CAAC,IAAI,CAAC,iBAAiB,EAAE,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IACnE,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,CAAC;QACd,GAAG;aACA,MAAM,CAAC,mBAAI,CAAC,WAAW,CAAC;aACxB,IAAI,CAAC,EAAE,KAAK,EAAE,cAAc,CAAC,kBAAkB,EAAE,CAAC,CAAC;QACtD,OAAO,CAAC,2BAA2B;IACrC,CAAC;IAED,kDAAkD;IAClD,IAAI,EAAE,GAAG,EAAE,QAAQ,EAAE,eAAe,EAAE,GAAG,GAAG,CAAC,IAAI,CAAC;IAElD,8CAA8C;IAC9C,IAAI,CAAC;QACH,MAAM,MAAM,GAAG,MAAM,wBAAc,CAAC,aAAa,CAC/C,GAAG,EACH,QAAQ,EACR,eAAe,CAChB,CAAC;QAEF,IAAI,MAAM,EAAE,CAAC;YACX,GAAG,CAAC,MAAM,CAAC,mBAAI,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QACzC,CAAC;aAAM,CAAC;YACN,MAAM,IAAI,KAAK,CAAC,kCAAkC,CAAC,CAAC;QACtD,CAAC;IACH,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,MAAM,MAAM,GAAG,cAAc,CAAC,qBAAqB,CAAC,iBAAiB,CAAC,CAAC;QACvE,OAAO,CAAC,KAAK,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;QAC7B,GAAG,CAAC,MAAM,CAAC,mBAAI,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;IACtD,CAAC;AACH,CAAC,CAAC,CAAC;AAEH,kBAAe,MAAM,CAAC","sourcesContent":["import express, { Request, Response } from 'express';\nimport authController from '@controllers/authController/authController';\nimport HTTP from '@Util/HTTPCodes';\nimport Auth from '@controllers/authController/auth_types';\nimport bcrypt from 'bcryptjs';\nimport dotenv from 'dotenv';\nimport { jwtService } from '../services/jwtService';\nimport { UserHeaders, verifySession } from '@Util/Session_Util';\n\ndotenv.config();\n\nconst router = express.Router();\nconst salt = bcrypt.genSaltSync(10);\nconst ERROR_MESSAGES = {\n  EMPTY_REQUEST_BODY: 'Request body cannot be empty',\n  INTERNAL_SERVER_ERROR: (route: string) => `Internal server error in ${route}`,\n} as const;\n\nfunction extractUserHeaders(req: Request): UserHeaders {\n  return {\n    agent: req.headers['user-agent'] || '',\n    ip_addr: req.ip || '',\n  };\n}\n\n/**Routes */\n// Login\nrouter.post('/login', async (req: Request, res: Response) => {\n  const { email, password } = req.body;\n  if (!email || !password)\n    return res\n      .status(HTTP.BAD_REQUEST)\n      .json({ error: 'Email and password are required' });\n\n  try {\n    const user = await authController.authenticate(email, password);\n    if (!user)\n      return res\n        .status(HTTP.UNAUTHORIZED)\n        .json({ error: 'Incorrect email or password' });\n\n    const userHeaders = extractUserHeaders(req);\n    const accessToken = jwtService.generateToken(\n      { orgId: process.env.JWT_ORG_ID!, userId: user.id!, type: user.type },\n      userHeaders,\n    );\n    const refreshToken = jwtService.generateToken(\n      { orgId: process.env.JWT_ORG_ID!, userId: user.id!, type: user.type },\n      userHeaders,\n      undefined,\n      true,\n    );\n\n    const accessCookie = jwtService.setAccessCookie(accessToken);\n    const refreshCookie = jwtService.setRefreshCookie(refreshToken);\n\n    res.cookie(accessCookie.name, accessCookie.value, accessCookie.config);\n    res.cookie(refreshCookie.name, refreshCookie.value, refreshCookie.config);\n\n    res.status(HTTP.OK).json(user);\n  } catch (err) {\n    res.status(HTTP.SERVER_ERR).json({ error: 'Internal server error' });\n  }\n});\n\n// Refresh\nrouter.post('/refresh', async (req: Request, res: Response) => {\n  const token = req.cookies?.refresh_token;\n  const userHeaders = extractUserHeaders(req);\n  if (!token)\n    return res\n      .status(HTTP.UNAUTHORIZED)\n      .json({ error: 'Missing refresh token' });\n\n  const payload = jwtService.verifyRefreshToken(token);\n  if (!payload)\n    return res\n      .status(HTTP.UNAUTHORIZED)\n      .json({ error: 'Invalid or expired refresh token' });\n\n  if (\n    payload.session_token &&\n    !verifySession(payload.session_token, userHeaders)\n  ) {\n    return res.status(HTTP.UNAUTHORIZED).json({ error: 'Session mismatch' });\n  }\n\n  const newAccessToken = jwtService.generateToken(\n    payload,\n    userHeaders,\n    payload.session_token,\n  );\n  const newRefreshToken = jwtService.generateToken(\n    payload,\n    userHeaders,\n    payload.session_token,\n    true,\n  );\n\n  const accessCookie = jwtService.setAccessCookie(newAccessToken);\n  const refreshCookie = jwtService.setRefreshCookie(newRefreshToken);\n\n  res.cookie(accessCookie.name, accessCookie.value, accessCookie.config);\n  res.cookie(refreshCookie.name, refreshCookie.value, refreshCookie.config);\n\n  res.status(HTTP.OK).json({ message: 'Tokens refreshed' });\n});\n\n// Sign-up\nrouter.post('/signup', async (req: Request, res: Response) => {\n  if (!req.body || Object.keys(req.body).length === 0) {\n    res\n      .status(HTTP.BAD_REQUEST)\n      .json({ error: ERROR_MESSAGES.EMPTY_REQUEST_BODY });\n    return;\n  }\n\n  const payload: Auth.UserInfo = req.body;\n\n  try {\n    const result = await authController.registerUser(payload);\n\n    if (result) {\n      res.status(HTTP.CREATED).json(result);\n    } else {\n      throw new Error('Insertion result is undefined');\n    }\n  } catch (error) {\n    const errMsg = ERROR_MESSAGES.INTERNAL_SERVER_ERROR('/signup');\n    console.error(errMsg, error);\n    res.status(HTTP.SERVER_ERR).json({ error: errMsg });\n  }\n});\n\n// Forgot password\nrouter.post('/forgot-password', async (req: Request, res: Response) => {\n  if (!req.body) {\n    res\n      .status(HTTP.BAD_REQUEST)\n      .json({ error: ERROR_MESSAGES.EMPTY_REQUEST_BODY });\n    return; // Exit if validation fails\n  }\n\n  let email = req.body.email;\n\n  try {\n    const result = await authController.forgotPassword(email);\n\n    if (result) {\n      res.status(HTTP.ACCEPTED).json(result);\n    } else {\n      throw new Error('Email check returns undefined');\n    }\n  } catch (error) {\n    const errMsg = ERROR_MESSAGES.INTERNAL_SERVER_ERROR('/forgot-password');\n    console.error(errMsg, error);\n    res.status(HTTP.SERVER_ERR).json({ error: errMsg });\n  }\n});\n\n// Reset password\nrouter.post('/reset-password', async (req: Request, res: Response) => {\n  if (!req.body) {\n    res\n      .status(HTTP.BAD_REQUEST)\n      .json({ error: ERROR_MESSAGES.EMPTY_REQUEST_BODY });\n    return; // Exit if validation fails\n  }\n\n  // Accept variables from front-end and deconstruct\n  let { otp, password, confirmPassword } = req.body;\n\n  // Pass arguments to reset password controller\n  try {\n    const result = await authController.resetPassword(\n      otp,\n      password,\n      confirmPassword,\n    );\n\n    if (result) {\n      res.status(HTTP.ACCEPTED).json(result);\n    } else {\n      throw new Error('Reset password returns undefined');\n    }\n  } catch (error) {\n    const errMsg = ERROR_MESSAGES.INTERNAL_SERVER_ERROR('/reset-password');\n    console.error(errMsg, error);\n    res.status(HTTP.SERVER_ERR).json({ error: errMsg });\n  }\n});\n\nexport default router;\n"]}